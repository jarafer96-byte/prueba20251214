
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Vista previa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:title" content="">
  <meta property="og:description" content="">
  <meta property="og:image" content="">
  <meta property="og:image:type" content="image/jpeg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">

  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Playfair+Display&family=Fira+Code&family=Raleway&family=Quicksand&family=Pacifico&family=Source+Serif+4&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <link rel="icon" type="image/png" sizes="32x32" href="/static/img/favicon32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/img/favicon16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/img/faviconmovil.png">

<style>
#adminCard {
  max-width: 500px;
  margin-left: auto;
  margin-right: auto;
}
body {
  background-color: #64636d;
}
body.container.py-5.modo-oscuro {
  position: relative !important;
  border-radius: 40px !important;
  padding: 60px !important;
  margin: 20px auto;
}

body.container.py-5.modo-oscuro::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    linear-gradient(135deg, rgba(30, 41, 59, 0.4) 0%, rgba(15, 23, 42, 0.6) 100%),
    radial-gradient(circle at 15% 15%, rgba(139, 92, 246, 0.2) 0%, transparent 30%),
    radial-gradient(circle at 85% 85%, rgba(14, 165, 233, 0.2) 0%, transparent 30%);
  backdrop-filter: blur(40px) saturate(220%) brightness(1.2);
  -webkit-backdrop-filter: blur(40px) saturate(220%) brightness(1.2);
  border-radius: 40px;
  z-index: -1;
}

/* Mant√©n el box-shadow en el body */
body.container.py-5.modo-oscuro {
  box-shadow: 
    0 50px 120px rgba(0, 0, 0, 0.8),
    0 0 0 2px rgba(255, 255, 255, 0.2),
    inset 0 4px 30px rgba(255, 255, 255, 0.1),
    inset 0 -4px 20px rgba(0, 0, 0, 0.4) !important;
}
  
h1, h2, h3, .btn, .card { font-family: 'Raleway', sans-serif; }

.card { transition: transform 0.3s ease, box-shadow 0.3s ease; border-radius: 12px; overflow: hidden; will-change: transform, box-shadow; padding: 12px; }
.card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }

.modo-oscuro { color: white; }
.modo-claro { color: #333; }

.oculta { display: none !important; }

.barra-navegacion { position: fixed; padding: 8px 10px; gap: 8px; top: 0; left: 0; right: 0; z-index: 1000; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(6px); display: flex; justify-content: center; box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1); }
.barra-navegacion button { font-family: 'Raleway', sans-serif; font-weight: 600; font-size: 14px; padding: 8px 15px; border-radius: 30px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.05); color: white; box-shadow: 0 0 6px rgba(255, 255, 255, 0.2); transition: all 0.3s ease; }
.barra-navegacion button:hover { background-color: #fff; color: #333; transform: scale(1.05); box-shadow: 0 0 8px none; }

.panel-grupos { position: fixed; scrollbar-width: none; -webkit-overflow-scrolling: touch; overflow-y: hidden; overflow-x: auto; white-space: nowrap; cursor: grab; cursor: -webkit-grab; border: 1px solid #000000f5; max-height: 50vh; overflow-y: auto; left: 0; right: 0; z-index: 906; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(6px); padding: 1px 0; text-align: center; box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1); }
.panel-grupos button { font-family: 'Raleway', sans-serif; font-size: 13px; font-weight: 600; margin: 6px; padding: 1px 6px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.05); color: white; box-shadow: 0 0 6px rgba(255, 255, 255, 0.2); cursor: pointer; transition: all 0.3s ease; }
.panel-grupos button:hover { background-color: #fff; color: #333; transform: scale(1.05); box-shadow: 0 0 8px none; }

.panel-subcategorias { position: fixed; scrollbar-width: none; -webkit-overflow-scrolling: touch; overflow-y: hidden; overflow-x: auto; white-space: nowrap; cursor: grab; cursor: -webkit-grab; border: 1px solid #000000f5; max-height: 50vh; overflow-y: auto; left: 0; right: 0; z-index: 908; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(6px); padding: 1px 0; text-align: center; box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
.panel-subcategorias button { font-family: 'Raleway', sans-serif; font-size: 13px; font-weight: 600; margin: 6px; padding: 1px 6px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.05); color: white; box-shadow: 0 0 6px rgba(255, 255, 255, 0.2); cursor: pointer; transition: all 0.3s ease; }
.panel-subcategorias button:hover { background-color: #fff; color: #333; transform: scale(1.05); box-shadow: 0 0 8px none; }


.logo { height: 40vw; max-height: 380px; filter: brightness(1.5) contrast(1.2) drop-shadow(0 0 14px white); transition: filter 0.3s ease; animation: pulsoLogo 4s ease-in-out infinite; }
@media (min-width: 1024px) { .logo { width: 150px; height: 150px; max-height: none; } }


.descripcion-emprendimiento { background-color: rgba(0, 0, 0, 0.5); color: white; padding: 20px; border-radius: 10px; display: inline-block; max-width: 800px; white-space: pre-line; text-align: center; text-indent: 20px; font-size: 16px; line-height: 1.6; box-shadow: 0 0 6px rgba(255,255,255,0.3); }

.btn-volver-arriba { background-color: white; color: black; border: none; font-size: 20px; box-shadow: 0 0 6px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; -webkit-tap-highlight-color: transparent; }
.btn-volver-arriba:hover { background-color: #f0f0f0; transform: scale(1.1); }

.social-icons { margin-top: 40px; display: flex; justify-content: center; gap: 20px; }
.social-icons img { width: 40px; transition: transform 0.3s ease; }
.social-icons img:hover { transform: scale(1.1); filter: drop-shadow(0 0 0 transparent); }
  
.bloque-ubicacion { background-color: rgba(0, 0, 0, 0.5); color: white; padding: 12px 16px; border-radius: 10px; text-align: center; max-width: 600px; margin: 20px auto 0; box-shadow: 0 0 6px rgba(255,255,255,0.3); }

#carrito { position: fixed; bottom: 80px; right: 20px; padding: 15px; border-radius: 10px; width: 320px; z-index: 999; display: none; }
#toggleCarrito { position: fixed; bottom: 20px; right: 20px; z-index: 1000; padding: 10px 14px; border-radius: 50px; font-weight: bold; box-shadow: 0 0 5px white; cursor: pointer; }
.modo-oscuro #carrito { background-color: rgba(0,0,0,0.85); color: white; border: 1px solid white; box-shadow: 0 0 10px white; }

.productos-container { margin-top: 30px; }

.modal-talles-stock input[type="text"],
.modal-talles-stock input[type="number"] { font-size: 14px; }

.panel-grupos,
.panel-subcategorias { scroll-behavior: smooth; }

.panel-grupos:hover,
.panel-subcategorias:hover { cursor: ew-resize; }

#loginToggleBtn { z-index: 997; }
#loginFloatingForm { z-index: 997; }

#imgModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none;  align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.3s ease; opacity: 0; }
#imgModal.show { display: flex; opacity: 1; }

.card-giratoria { perspective: 1000px; height: 470px; border-radius: 12px !important; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.2) !important; background: transparent !important; }

.card-contenedor { position: relative; width: 100%; height: 100%; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d; }

.card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; padding: 15px; background-color: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
.card-front:hover, .card-back:hover { box-shadow: 0 12px 25px rgba(0,0,0,0.4); }

.card-back { transform: rotateY(180deg); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; overflow-y: auto; }
.card-back h5 { color: #ff6b8b; margin-bottom: 15px; font-size: 1.2rem; }
.card-back .precio { font-size: 1.5rem; font-weight: bold; color: #4cd964; margin: 10px 0; }
.card-back .descripcion { font-size: 0.9rem; line-height: 1.5; margin: 10px 0; max-height: 150px; overflow-y: auto; padding: 0 10px; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px; }

.btn-girar { position: absolute; right: 10px; width: 35px; height: 35px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 18px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
.btn-girar:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
.btn-reversa { position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 16px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
.preservar-saltos { white-space: pre-line; word-wrap: break-word; }
.btn-reversa:hover { background: rgba(255,255,255,0.2); }  

.fotos-adicionales { margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
.fotos-adicionales img { transition: transform 0.2s; border: 1px solid rgba(255,255,255,0.2); }
.fotos-adicionales img:hover { transform: scale(1.2); z-index: 10; position: relative; }  

</style>
</head>
<body class="container py-5 modo-oscuro">
  
  <div class="text-center my-5 logo-wrapper">
    <img src="/static/img/Copilot_20251101_125947.png"
         alt="Logo"
         class="img-fluid logo mx-auto d-block"
         loading="lazy">
  </div>

<div class="text-center mb-4">
    <div class="descripcion-emprendimiento">
      Horario de atencion:
      Lunes a Viernes de 09 a 20 hs
      Sabados de 09 a 14 hs
    </div>
  </div>
 
  
<div id="configurarMP" class="d-none" style="margin-top:10px;">
  <button class="btn btn-sm btn-primary" onclick="abrirConfigMercadoPago()">
    ‚öôÔ∏è Configurar Mercado Pago
  </button>
</div>
  
  <div class="text-center mt-5 mb-1">
    <select id="ordenPrecio" class="form-select w-auto d-inline-block">
      <option value="asc" selected>Precio: Menor a mayor</option>
      <option value="desc">Precio: Mayor a menor</option>
    </select>
  </div>
  
  <div class="barra-wrapper">
    <nav class="barra-navegacion">
      <button id="btnProductos" onclick="mostrarTodos()">Productos</button>
      <button id="btnContacto" onclick="irAContacto()">Contacto</button>
    </nav>
    <div id="panelGrupos" class="panel-grupos oculta">
    </div>
  </div>


<div id="panelSubcategorias" class="panel-subcategorias oculta"></div>

<div id="productos" class="row productos-container"></div>


  <button id="volverArriba" class="btn btn-volver-arriba" 
          style="position: fixed; bottom: 20px; left: 20px; display: none; z-index: 1000;">
    ‚Üë
  </button>

<div id="contenedor-grupos"></div>
  
<div id="adminCard" class="card producto-card admin-card d-none">
  <div class="card-body">
    <img id="previewFoto" src="" alt="Sin foto" class="d-none w-100 mb-2">
    <input type="file" id="inputFoto" accept="image/*" class="form-control mb-2">
    <button id="btnQuitarFoto" type="button" class="btn btn-danger mb-2 d-none">‚ùå Quitar foto</button>

    <div class="mb-2">
      <label class="form-label">Fotos adicionales (opcional)</label>
      <input type="file" id="fotosAdicionales" accept="image/*" 
             class="form-control" multiple>
      <small class="text-muted">Puedes seleccionar varias fotos</small>
      <div id="previewFotosAdicionales" class="mt-2"></div>
    </div>
    
    <input type="text" id="nombreProd" placeholder="Nombre producto *" class="form-control mb-2">
    <input type="number" id="precioProd" placeholder="Precio *" class="form-control mb-2">
    
    <textarea id="descripcionProd" placeholder="Descripci√≥n del producto (opcional)" 
          class="form-control mb-2 preservar-saltos" rows="3"></textarea>
    
    <input type="text" id="tallesProd" placeholder="Talles (S,M,L)" class="form-control mb-2">
    
    <div id="stockSimple" class="mb-2">
      <input type="number" id="stockGeneral" placeholder="Stock inicial" min="0" value="0" class="form-control">
    </div>
    
    <div id="stockPorTalleContainer" class="mb-2" style="display:none;">
      <label class="form-label">Stock por talle (ej: S:5, M:3, L:2)</label>
      <input type="text" id="stockPorTalle" placeholder="S:5, M:3, L:2" class="form-control">
      <small class="text-muted">Separar por comas: talle:cantidad</small>
    </div>

    <input type="text" id="grupoProd" list="grupos-sugeridos" placeholder="Grupo *" class="form-control mb-2">
    <datalist id="grupos-sugeridos">
    </datalist>
    
    <input type="text" id="subgrupoProd" list="subgrupos-sugeridos" placeholder="Subgrupo *" class="form-control mb-2">
    <datalist id="subgrupos-sugeridos">

    </datalist>

    <button id="btnConfirmarProd" class="btn btn-success">‚úÖ Confirmar</button>    

    <button id="btnCancelarEdicion" class="btn btn-secondary mt-2" onclick="resetearFormularioAdmin()" style="display:none;">
      ‚ùå Cancelar edici√≥n
    </button>
  </div>
</div>
  
<div id="paginacion" class="text-center mt-3"></div>


<div class="social-icons">
  
    <a href="https://www.facebook.com/laanonimaoficial/?locale=es_LA" target="_blank">
      <img src="/static/img/facebook.png" alt="Facebook" loading="lazy">
    </a>
  
    <a href="https://www.instagram.com/laanonimaoficial/" target="_blank">
      <img src="/static/img/instagram.png" alt="Instagram" loading="lazy">
    </a>
  
    <a href="https://wa.me/5492975158178" target="_blank">
      <img src="/static/img/whatsapp.png" alt="WhatsApp" loading="lazy">
    </a>
  
</div>


  <div id="ubicacion" class="bloque-ubicacion text-center mt-4" style="margin-bottom:120px;">
    <p style="margin-bottom: 6px;">
      üìç Corrientes 731 (Local 4)
    </p>
    
      <a href="https://maps.app.goo.gl/4UEnkZFeidM2cZhc8" target="_blank" style="text-decoration: none;">
        <span style="margin-right: 6px;">‚ûú</span>
        <img src="/static/img/map.png" alt="Ver en Google Maps" style="width: 30px;" loading="lazy">
      </a>
    
  </div>

  
<div id="loginFloatingForm" style="position:fixed; bottom:70px; left:50%; transform:translateX(-50%); z-index:999; display:none; background:rgba(0,0,0,0.9); padding:15px; border-radius:10px; width:250px;">
  <form onsubmit="loginAdmin(event)">
    <input type="text" id="usuario_login" placeholder="Usuario" required class="form-control mb-2">
    <input type="password" id="clave_login" placeholder="Contrase√±a" required class="form-control mb-2">
    <button type="submit" class="btn-grupo w-100">Entrar</button>
  </form>
</div>

<div class="text-center mt-4" id="logoutAdminWrapper" style="display:none;">
  <button type="button" class="btn-grupo" onclick="salirAdmin()">üö™ Salir de Admin</button>
</div>
  
<!-- Modifica tu HTML para un solo flujo -->
<div id="carrito">
  <div id="carritoCarousel" class="carousel slide" data-bs-ride="false">
    <div class="carousel-inner">
      
      <!-- Slide 1: Carrito -->
      <div class="carousel-item active">
        <h3>üõí Tu carrito</h3>
        <ul id="listaCarrito"></ul>
        <p><strong>Total:</strong> $<span id="totalCarrito">0</span></p>
        
        <form id="datosCliente" style="display: none;">
          <h4>üìù Tus datos</h4>
          <input type="text" name="nombre" placeholder="Nombre" class="form-control mb-2" required>
          <input type="text" name="apellido" placeholder="Apellido" class="form-control mb-2" required>
          <input type="email" name="email" placeholder="Email" class="form-control mb-2" required>
          <input type="tel" name="telefono" placeholder="Tel√©fono" class="form-control mb-2">
        </form>
        
        <div class="d-grid gap-2 mt-3">
          <button class="btn btn-sm btn-danger" onclick="vaciarCarrito()">Vaciar carrito</button>
          <button id="btnContinuar" class="btn btn-sm btn-success" onclick="mostrarFormulario()">
            Continuar con la compra
          </button>
          <button id="btnPagarFinal" class="btn btn-sm btn-primary" style="display: none;" onclick="pagarTodoJunto()">
            Pagar con Mercado Pago
          </button>
        </div>
      </div>
      
    </div>
  </div>
</div>

<button id="toggleCarrito">üõí</button>

<button id="loginToggleBtn" 
        style="position:fixed; bottom:20px; left:50%; transform:translateX(-50%); 
               z-index:997; display:none; background:rgba(0,0,0,0.8); color:white; 
               border:none; padding:10px 20px; border-radius:20px;">
  üîê Admin
</button>  
  
<div id="avisoPrecio" class="alert alert-success text-center" role="alert"
     style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;">
  ‚úî Precio actualizado
</div>

<!-- Aviso flotante de talle actualizado -->
<div id="avisoTalle" class="alert alert-info text-center" role="alert"
     style="display: none; position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 9999;">
  ‚úî Talle actualizado
</div>
  
<div id="imgModal" style="display:none;" onclick="closeModal()">
  <span class="close">&times;</span>
  <img id="modal-img" style="max-width:90%; max-height:90%;">
</div>
  
  <script>
const configWhatsApp = "https://wa.me/5492975158178";
// Opci√≥n B: leerlo de la URL si lo pas√°s como query param
const email = "ferj.9622@gmail.com";
const URL_BACKEND = "https://mpagina.onrender.com"; // Tu URL central

if (window.email) {
    email = window.email;
}
    
  // Mostrar/ocultar bot√≥n volver arriba
  window.addEventListener('scroll', () => {
    const btn = document.getElementById('volverArriba');
    btn.style.display = window.scrollY > 300 ? 'block' : 'none';
    btn.style.backgroundColor = 'white';
    btn.style.color = 'black';
  });

  document.getElementById('volverArriba').onclick = () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
    

// Mostrar/ocultar bot√≥n login al final de p√°gina
window.addEventListener('scroll', () => {
  const btn = document.getElementById('loginToggleBtn');
  if (!btn) return;
  
  // üî• NUEVO: No mostrar si ya estamos en modo admin
  if (window.modoAdmin) {
    btn.style.display = 'none';
    return;
  }
  
  const isBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 100;
  btn.style.display = isBottom ? 'block' : 'none';
});
document.getElementById('loginToggleBtn').onclick = () => {
  const form = document.getElementById('loginFloatingForm');
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
};
    
document.getElementById("tallesProd").addEventListener("input", function() {
  const talles = this.value.split(",").map(t => t.trim()).filter(Boolean);
  const container = document.getElementById("stockPorTalleContainer");
  const simpleContainer = document.getElementById("stockSimple");
  
  console.log("‚å®Ô∏è Talles ingresados:", talles);
  
  if (talles.length > 0) {
    container.style.display = "block";
    simpleContainer.style.display = "none";
    
    const stockPorTalleInput = document.getElementById("stockPorTalle");
    if (stockPorTalleInput) {
      // üî• NUEVO: Solo actualizar si estamos CREANDO un producto nuevo
      // o si el campo de stock est√° vac√≠o
      const estaEditando = !!window.productoEditandoId;
      const stockEstaVacio = !stockPorTalleInput.value.trim();
      
      console.log("üìù Estado:", {
        editando: estaEditando,
        stockVacio: stockEstaVacio,
        valorActual: stockPorTalleInput.value
      });
      
      // Solo actualizar autom√°ticamente si:
      // 1. NO estamos editando un producto (creando nuevo) Y el campo est√° vac√≠o
      // 2. O si estamos editando PERO el usuario acaba de borrar un talle
      if ((!estaEditando && stockEstaVacio) || stockEstaVacio) {
        // Crear stock inicial desde cero
        const nuevoStock = talles.map(t => `${t}:0`).join(", ");
        stockPorTalleInput.value = nuevoStock;
        console.log("üîÑ Stock por talle inicializado:", nuevoStock);
      } 
      // Si estamos editando Y ya hay stock definido, mantenerlo
      else if (estaEditando && !stockEstaVacio) {
        console.log("üìå Manteniendo stock existente durante edici√≥n");
        // No hacer nada - mantener el stock que ya estaba
      }
      // Si estamos creando nuevo pero ya hay algo escrito, actualizar manteniendo valores
      else if (!estaEditando && !stockEstaVacio) {
        try {
          // Parsear stock existente
          const stockExistente = {};
          stockPorTalleInput.value.split(",").forEach(item => {
            const parts = item.split(":").map(s => s.trim());
            if (parts.length >= 2) {
              const talle = parts[0];
              const stock = parseInt(parts[1]) || 0;
              stockExistente[talle] = stock;
            }
          });
          
          // Crear nuevo stock manteniendo valores existentes para talles que siguen
          const nuevoStock = talles.map(talle => {
            if (stockExistente[talle] !== undefined) {
              return `${talle}:${stockExistente[talle]}`;
            } else {
              return `${talle}:0`; // Nuevo talle, stock en 0
            }
          }).join(", ");
          
          // Tambi√©n eliminar talles que ya no est√°n en la lista
          stockPorTalleInput.value = nuevoStock;
          console.log("üîÑ Stock por talle actualizado manteniendo valores:", nuevoStock);
          
        } catch (error) {
          console.error("‚ùå Error procesando stock:", error);
          // Si hay error, crear stock desde cero
          const nuevoStock = talles.map(t => `${t}:0`).join(", ");
          stockPorTalleInput.value = nuevoStock;
        }
      }
    }
    
  } else {
    container.style.display = "none";
    simpleContainer.style.display = "block";
    console.log("üì≠ Sin talles, mostrando stock simple");
  }
});
function renderizarProductos(productos) {
  console.log("üé® Renderizando productos:", productos.length);
  
  const cont = document.getElementById("productos");
  if (!cont) {
    console.warn("‚ö†Ô∏è No se encontr√≥ el contenedor #productos");
    return;
  }
  
  cont.innerHTML = ""; // Limpiar contenedor
  
  productos.forEach(p => {
    const card = renderProducto(p);
    cont.appendChild(card);
    
    // Animaci√≥n
    setTimeout(() => {
      card.classList.remove("fade-reorder");
      card.classList.add("show");
    }, 50);
  });
  
  console.log("‚úÖ " + productos.length + " productos renderizados");
} 
function cargarProductoCompletoParaEditar(id_base) {
  const producto = window.todosLosProductos?.find(p => p.id_base === id_base);
  if (producto) {
    cargarProductoEnFormulario(producto);
  } else {
    alert("‚ùå No se encontr√≥ el producto para editar");
  }
}
function cargarProductoEnFormulario(producto) {
  console.log("üìù Cargando producto para editar:", producto.nombre);
  console.log("üîç Datos del producto recibidos:", {
    talles: producto.talles,
    stock_por_talle: producto.stock_por_talle,
    tiene_talles_array: Array.isArray(producto.talles),
    tiene_stock_por_talle: !!producto.stock_por_talle,
    fotos_adicionales_count: producto.fotos_adicionales ? producto.fotos_adicionales.length : 0
  });
  
  // Mostrar formulario admin
  const adminCard = document.getElementById("adminCard");
  adminCard.classList.remove("d-none");
  
  // Activar modo edici√≥n
  toggleModoEdicion(true);
  
  // Llenar campos con datos del producto
  document.getElementById("nombreProd").value = producto.nombre || "";
  document.getElementById("precioProd").value = producto.precio || "";
  document.getElementById("descripcionProd").value = producto.descripcion || "";
  document.getElementById("grupoProd").value = producto.grupo || "";
  document.getElementById("subgrupoProd").value = producto.subgrupo || "";
  
  // 1. Obtener talles del producto - CON M√ÅS DEBUG
  let tallesArray = [];
  console.log("üîç Analizando talles del producto...");
  
  if (Array.isArray(producto.talles)) {
    tallesArray = producto.talles;
    console.log("‚úÖ Talles como array:", tallesArray);
    document.getElementById("tallesProd").value = producto.talles.join(", ");
  } else if (typeof producto.talles === 'string') {
    tallesArray = producto.talles.split(",").map(t => t.trim()).filter(Boolean);
    console.log("‚úÖ Talles como string convertido:", tallesArray);
    document.getElementById("tallesProd").value = producto.talles;
  } else {
    console.log("‚ö†Ô∏è No se encontraron talles o formato inv√°lido:", producto.talles);
    document.getElementById("tallesProd").value = "";
  }
  
  console.log("üìã Talles finales:", tallesArray);
  
  // 2. Determinar qu√© campo de stock mostrar
  if (tallesArray.length > 0) {
    console.log("üîÑ Producto CON talles, mostrando stock por talle");
    document.getElementById("stockPorTalleContainer").style.display = "block";
    document.getElementById("stockSimple").style.display = "none";
    
    // üî• CORRECCI√ìN MEJORADA con m√°s logs
    let stockPorTalleStr = "";
    
    if (producto.stock_por_talle && Object.keys(producto.stock_por_talle).length > 0) {
      const stockPorTalle = producto.stock_por_talle;
      console.log("üìä Stock por talle original:", stockPorTalle);
      
      const stockFiltrado = {};
      let tallesFiltrados = 0;
      let tallesIgnorados = [];
      
      // Solo incluir stock para los talles que existen
      tallesArray.forEach(talle => {
        if (stockPorTalle[talle] !== undefined) {
          stockFiltrado[talle] = stockPorTalle[talle];
          tallesFiltrados++;
          console.log(`‚úÖ Talle "${talle}" encontrado en stock: ${stockPorTalle[talle]}`);
        } else {
          stockFiltrado[talle] = 0; // Talle nuevo, stock en 0
          console.log(`‚ö†Ô∏è Talle "${talle}" NO encontrado en stock, asignando 0`);
        }
      });
      
      // Verificar si hay talles en stock que ya no est√°n en tallesArray
      Object.keys(stockPorTalle).forEach(talle => {
        if (!tallesArray.includes(talle) && talle !== "unico") {
          tallesIgnorados.push(`${talle}:${stockPorTalle[talle]}`);
          console.log(`üóëÔ∏è Talle "${talle}" ser√° ignorado porque no est√° en tallesArray`);
        }
      });
      
      if (tallesIgnorados.length > 0) {
        console.log("üìå Talles ignorados del stock:", tallesIgnorados.join(", "));
      }
      
      // Crear string para el input
      stockPorTalleStr = Object.entries(stockFiltrado)
        .map(([talle, stock]) => `${talle}:${stock}`)
        .join(", ");
      
      console.log("üîÑ Stock por talle filtrado:", stockFiltrado);
      console.log("üìù String generado:", stockPorTalleStr);
      
    } else {
      // Si no hay stock definido, crear uno inicial
      stockPorTalleStr = tallesArray.map(t => `${t}:0`).join(", ");
      console.log("‚ûï Creando stock inicial:", stockPorTalleStr);
    }
    
    document.getElementById("stockPorTalle").value = stockPorTalleStr;
    
  } else {
    console.log("üîÑ Producto SIN talles, mostrando stock simple");
    document.getElementById("stockPorTalleContainer").style.display = "none";
    document.getElementById("stockSimple").style.display = "block";
    
    // Determinar stock general
    let stockGeneral = 0;
    if (producto.stock_por_talle && producto.stock_por_talle["unico"] !== undefined) {
      stockGeneral = producto.stock_por_talle["unico"];
      console.log("üìä Stock general (unico):", stockGeneral);
    } else if (producto.stock) {
      stockGeneral = producto.stock;
      console.log("üìä Stock general (stock):", stockGeneral);
    } else {
      console.log("üìä Sin stock definido, usando 0");
    }
    
    document.getElementById("stockGeneral").value = stockGeneral;
  }
  
  // 3. Imagen principal
  if (producto.imagen_url) {
    const previewFoto = document.getElementById("previewFoto");
    previewFoto.src = producto.imagen_url;
    previewFoto.classList.remove("d-none");
    document.getElementById("btnQuitarFoto").classList.remove("d-none");
    console.log("üñºÔ∏è Imagen principal cargada:", producto.imagen_url);
  } else {
    document.getElementById("previewFoto").classList.add("d-none");
    document.getElementById("btnQuitarFoto").classList.add("d-none");
    console.log("üñºÔ∏è Sin imagen principal");
  }
  
  // üî• 4. NUEVO: Cargar fotos adicionales
  const previewDiv = document.getElementById("previewFotosAdicionales");
  if (previewDiv) {
    previewDiv.innerHTML = '';
    
    // Guardar las fotos adicionales existentes en variable global
    window.fotosAdicionalesExistentes = producto.fotos_adicionales || [];
    
    if (window.fotosAdicionalesExistentes.length > 0) {
      console.log(`üñºÔ∏è Mostrando ${window.fotosAdicionalesExistentes.length} fotos adicionales existentes`);
      
      window.fotosAdicionalesExistentes.forEach((url, index) => {
        const img = document.createElement("img");
        img.src = url;
        img.style.width = '80px';
        img.style.height = '80px';
        img.style.objectFit = 'cover';
        img.style.margin = '5px';
        img.style.borderRadius = '4px';
        img.style.cursor = 'pointer';
        img.style.border = '2px solid #ccc';
        img.title = `Foto adicional ${index + 1}`;
        
        // Agregar bot√≥n para eliminar esta foto espec√≠fica
        const container = document.createElement("div");
        container.style.position = 'relative';
        container.style.display = 'inline-block';
        
        const btnEliminar = document.createElement("button");
        btnEliminar.innerHTML = "√ó";
        btnEliminar.style.position = 'absolute';
        btnEliminar.style.top = '-5px';
        btnEliminar.style.right = '-5px';
        btnEliminar.style.background = 'red';
        btnEliminar.style.color = 'white';
        btnEliminar.style.border = 'none';
        btnEliminar.style.borderRadius = '50%';
        btnEliminar.style.width = '20px';
        btnEliminar.style.height = '20px';
        btnEliminar.style.cursor = 'pointer';
        btnEliminar.style.fontSize = '14px';
        btnEliminar.style.fontWeight = 'bold';
        btnEliminar.title = 'Eliminar esta foto';
        
        btnEliminar.onclick = (e) => {
          e.stopPropagation();
          if (confirm(`¬øEliminar foto adicional ${index + 1}?`)) {
            // Eliminar de la lista de fotos existentes
            window.fotosAdicionalesExistentes = window.fotosAdicionalesExistentes.filter((_, i) => i !== index);
            // Actualizar la vista
            cargarProductoEnFormulario(producto); // Recargar
            console.log(`üóëÔ∏è Foto adicional ${index + 1} eliminada`);
          }
        };
        
        img.onclick = () => openModal(url);
        
        container.appendChild(img);
        container.appendChild(btnEliminar);
        previewDiv.appendChild(container);
      });
    } else {
      console.log("üñºÔ∏è No hay fotos adicionales existentes");
      previewDiv.innerHTML = '<small class="text-muted">No hay fotos adicionales</small>';
    }
  } else {
    console.log("‚ö†Ô∏è No se encontr√≥ el div previewFotosAdicionales");
  }
  
  // 5. Guardar ID del producto que estamos editando
  window.productoEditandoId = producto.id_base;
  console.log("üîë ID del producto en edici√≥n:", window.productoEditandoId);
  
  // 6. Scroll al formulario
  adminCard.scrollIntoView({ behavior: 'smooth' });
  
  console.log("‚úÖ Producto cargado correctamente en formulario");
  console.log(`üì∏ Fotos adicionales guardadas para edici√≥n: ${window.fotosAdicionalesExistentes ? window.fotosAdicionalesExistentes.length : 0}`);
}
function toggleModoEdicion(editando) {
  const btnCancelar = document.getElementById("btnCancelarEdicion");
  const btnConfirmar = document.getElementById("btnConfirmarProd");
  const titulo = document.getElementById("tituloFormularioAdmin") || document.createElement("h5");
  
  if (editando) {
    // üî• NUEVO: Si hay un elemento para t√≠tulo, actualizarlo
    if (titulo && titulo.id === "tituloFormularioAdmin") {
      titulo.textContent = "‚úèÔ∏è Editando Producto";
      titulo.classList.add("text-warning");
    }
    
    btnCancelar.style.display = "block";
    btnConfirmar.innerHTML = "üíæ Actualizar Producto";
    btnConfirmar.classList.remove("btn-success");
    btnConfirmar.classList.add("btn-warning");
    console.log("üîß Modo edici√≥n activado");
  } else {
    // üî• NUEVO: Restaurar t√≠tulo
    if (titulo && titulo.id === "tituloFormularioAdmin") {
      titulo.textContent = "‚ûï Nuevo Producto";
      titulo.classList.remove("text-warning");
    }
    
    btnCancelar.style.display = "none";
    btnConfirmar.innerHTML = "‚úÖ Confirmar";
    btnConfirmar.classList.remove("btn-warning");
    btnConfirmar.classList.add("btn-success");
    console.log("üîß Modo creaci√≥n activado");
  }
}
function resetearFormularioAdmin() {
  console.log("üîÑ Reseteando formulario admin...");
  
  // 1. Limpiar todos los campos
  document.getElementById("nombreProd").value = "";
  document.getElementById("precioProd").value = "";
  document.getElementById("descripcionProd").value = "";
  document.getElementById("tallesProd").value = "";
  document.getElementById("stockGeneral").value = "0";
  document.getElementById("stockPorTalle").value = "";
  document.getElementById("grupoProd").value = "";
  document.getElementById("subgrupoProd").value = "";
  
  // 2. Resetear visibilidad
  document.getElementById("stockPorTalleContainer").style.display = "none";
  document.getElementById("stockSimple").style.display = "block";
  
  // 3. Resetear foto principal
  document.getElementById("previewFoto").src = "";
  document.getElementById("previewFoto").classList.add("d-none");
  document.getElementById("btnQuitarFoto").classList.add("d-none");
  document.getElementById("inputFoto").value = "";
  window.fotoOptimizada = null;
  
  // üî• 4. NUEVO: Resetear fotos adicionales
  const previewDiv = document.getElementById("previewFotosAdicionales");
  if (previewDiv) {
    previewDiv.innerHTML = '';
    console.log("‚úÖ Preview de fotos adicionales limpiado");
  }
  
  const fotosInput = document.getElementById("fotosAdicionales");
  if (fotosInput) {
    fotosInput.value = "";
    console.log("‚úÖ Input de fotos adicionales limpiado");
  }
  
  // üî• 5. Limpiar variables temporales de fotos adicionales
  window.fotosAdicionalesExistentes = null;
  console.log("‚úÖ Variables de fotos adicionales limpiadas");
  
  // 6. Cambiar bot√≥n a modo creaci√≥n
  const btnConfirmar = document.getElementById("btnConfirmarProd");
  if (btnConfirmar) {
    btnConfirmar.innerHTML = "‚úÖ Confirmar";
    btnConfirmar.classList.remove("btn-warning");
    btnConfirmar.classList.add("btn-success");
    console.log("‚úÖ Bot√≥n cambiado a modo creaci√≥n");
  }
  
  // 7. Ocultar bot√≥n cancelar
  const btnCancelar = document.getElementById("btnCancelarEdicion");
  if (btnCancelar) {
    btnCancelar.style.display = "none";
    console.log("‚úÖ Bot√≥n cancelar ocultado");
  }
  
  // 8. Limpiar ID de edici√≥n
  window.productoEditandoId = null;
  console.log("‚úÖ ID de edici√≥n limpiado");
  
  // üî• 9. NUEVO: Desactivar modo edici√≥n
  if (typeof toggleModoEdicion === "function") {
    toggleModoEdicion(false);
  }
  
  console.log("‚úÖ Formulario admin completamente reseteado");
}
function actualizarStockPorTalle(idProducto, talleSeleccionado) {
  console.log(`üìä [actualizarStockPorTalle] id: ${idProducto}, talle: ${talleSeleccionado}`);
  
  const stockSpan = document.getElementById(`stock_${idProducto}`);
  const cantidadInput = document.getElementById(`cantidad_${idProducto}`);
  const agregarBtn = document.getElementById(`btn_agregar_${idProducto}`);
  
  if (!stockSpan || !cantidadInput || !agregarBtn) {
    console.warn("‚ö†Ô∏è Elementos no encontrados");
    return;
  }
  
  // üî• Obtener stock del talle seleccionado
  let stockDisponible = 0;
  const stockPorTalle = window[`stock_por_talle_${idProducto}`];
  
  if (stockPorTalle && stockPorTalle[talleSeleccionado] !== undefined) {
    stockDisponible = stockPorTalle[talleSeleccionado];
    console.log(`‚úÖ Stock obtenido: ${stockDisponible} para talle ${talleSeleccionado}`);
  } else {
    console.warn(`‚ö†Ô∏è Talle ${talleSeleccionado} no encontrado en stock_por_talle`);
    stockDisponible = 0;
  }
  
  // Actualizar UI
  stockSpan.textContent = stockDisponible > 0 ? stockDisponible : "Sin stock";
  
  if (stockDisponible > 0) {
    stockSpan.classList.remove("text-danger");
    stockSpan.classList.add("text-success");
    setTimeout(() => stockSpan.classList.remove("text-success"), 1000);
    
    cantidadInput.max = stockDisponible;
    cantidadInput.disabled = false;
    const valorActual = parseInt(cantidadInput.value) || 1;
    cantidadInput.value = Math.min(valorActual, stockDisponible);
    
    agregarBtn.disabled = false;
    agregarBtn.style.opacity = "1";
    agregarBtn.textContent = "Agregar al carrito";
  } else {
    stockSpan.classList.remove("text-success");
    stockSpan.classList.add("text-danger");
    
    cantidadInput.disabled = true;
    cantidadInput.value = "0";
    
    agregarBtn.disabled = true;
    agregarBtn.style.opacity = "0.5";
    agregarBtn.textContent = "Sin stock";
  }
}
// üî• EFECTO PARALLAX CON GIROSCOPIO - AGREGAR AL FINAL DEL SCRIPT
document.addEventListener('DOMContentLoaded', function() {
  // Esperar a que todo cargue
  setTimeout(function() {
    const fondo = document.getElementById('fondoParallax');
    if (!fondo) return;
    
    console.log("üéÆ Inicializando efecto parallax...");
    
    let intensity = 0.03; // Intensidad del efecto (0.01 = suave, 0.1 = fuerte)
    let lastX = 0;
    let lastY = 0;
    
    // 1. Efecto con giroscopio (dispositivos m√≥viles)
    if (window.DeviceOrientationEvent) {
      console.log("üì± Usando giroscopio para efecto parallax");
      
      window.addEventListener('deviceorientation', function(event) {
        const gamma = event.gamma || 0; // Inclinaci√≥n izquierda-derecha (-90 a 90)
        const beta = event.beta || 0;   // Inclinaci√≥n adelante-atr√°s (-180 a 180)
        
        // Convertir a valores entre -1 y 1
        const moveX = (gamma / 90) * intensity * 100;
        const moveY = ((beta - 90) / 90) * intensity * 100;
        
        // Suavizar movimiento
        lastX = moveX * 0.8 + lastX * 0.2;
        lastY = moveY * 0.8 + lastY * 0.2;
        
        fondo.style.transform = `translate(${lastX}px, ${lastY}px)`;
      });
    }
    
    // 2. Efecto con mouse (computadoras)
    else {
      console.log("üñ±Ô∏è Usando mouse para efecto parallax");
      
      document.addEventListener('mousemove', function(e) {
        // Calcular posici√≥n del mouse (0 a 1)
        const mouseX = e.clientX / window.innerWidth;
        const mouseY = e.clientY / window.innerHeight;
        
        // Mover fondo en direcci√≥n opuesta
        const moveX = (mouseX - 0.5) * 30 * intensity;
        const moveY = (mouseY - 0.5) * 30 * intensity;
        
        // Suavizar
        lastX = moveX * 0.1 + lastX * 0.9;
        lastY = moveY * 0.1 + lastY * 0.9;
        
        fondo.style.transform = `translate(${lastX}px, ${lastY}px)`;
      });
    }
    
    // 3. Efecto con scroll (parallax cl√°sico)
    window.addEventListener('scroll', function() {
      const scrolled = window.pageYOffset;
      const moveY = scrolled * -0.3; // 30% de velocidad
      
      // Combinar con otros efectos si no hay giroscopio
      if (!window.DeviceOrientationEvent) {
        fondo.style.transform = `translate(0px, ${lastY + moveY}px)`;
      }
    });
    
    // 4. Mostrar fondo despu√©s de cargar
    setTimeout(function() {
      fondo.style.opacity = '1';
      console.log("‚úÖ Efecto parallax activado");
    }, 800);
    
  }, 1000); // Esperar 1 segundo
});

// üî• FUNCI√ìN PARA AJUSTAR INTENSIDAD (opcional - para debug)
function ajustarIntensidadParallax(nuevaIntensidad) {
  intensity = nuevaIntensidad;
  console.log(`üéöÔ∏è Intensidad parallax ajustada a: ${intensidad}`);
}    
/////////////////////////////////
function habilitarScrollHorizontal(selector) {
  const panel = document.querySelector(selector);
  if (!panel) return;

  // 1Ô∏è‚É£ Scroll horizontal con la rueda del mouse (animado)
  panel.addEventListener('wheel', (e) => {
    e.preventDefault(); // evita scroll vertical
    panel.scrollBy({
      left: e.deltaY,
      behavior: 'smooth' // animaci√≥n suave
    });
  });

  // 2Ô∏è‚É£ Scroll horizontal arrastrando con el mouse
  let isDown = false;
  let startX;
  let scrollLeft;

  panel.addEventListener('mousedown', (e) => {
    isDown = true;
    panel.classList.add('active'); // opcional: estilo visual
    startX = e.pageX - panel.offsetLeft;
    scrollLeft = panel.scrollLeft;
  });

  panel.addEventListener('mouseleave', () => {
    isDown = false;
    panel.classList.remove('active');
  });

  panel.addEventListener('mouseup', () => {
    isDown = false;
    panel.classList.remove('active');
  });

  panel.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - panel.offsetLeft;
    const walk = (x - startX); // cantidad de movimiento
    panel.scrollLeft = scrollLeft - walk;
  });
}

// Activar en ambos paneles
habilitarScrollHorizontal('.panel-grupos');
habilitarScrollHorizontal('.panel-subcategorias');

////////////////////////////////////////////////////     
// Configuraci√≥n de paginaci√≥n
const itemsPorPagina = 12;
let totalPaginas = 0;

// üëâ Flag de admin (puede venir de tu token backend)
const modoAdmin = window.tokenAdminEmail ? true : false;

if (modoAdmin) {
  document.getElementById("adminCard").classList.remove("d-none");
}   
    
function openModal(src) {
  const modal = document.getElementById("imgModal");
  document.getElementById("modal-img").src = src;
  modal.style.display = "flex";
  setTimeout(() => modal.classList.add("show"), 10); // activa animaci√≥n
}
    
function closeModal() {
  const modal = document.getElementById("imgModal");
  modal.classList.remove("show");
  setTimeout(() => modal.style.display = "none", 300); // espera animaci√≥n
}
// ========== FUNCIONES NUEVAS PARA EL CARRITO ==========

// 1. Mostrar formulario de datos del cliente (NUEVA)
function mostrarFormulario() {
    console.log("üìù Mostrando formulario de datos del cliente");
    
    // Mostrar el formulario de datos del cliente
    const datosCliente = document.getElementById('datosCliente');
    if (datosCliente) {
        datosCliente.style.display = 'block';
    }
    
    // Ocultar el bot√≥n "Continuar con la compra"
    const btnContinuar = document.getElementById('btnContinuar');
    if (btnContinuar) {
        btnContinuar.style.display = 'none';
    }
    
    // Mostrar el bot√≥n "Pagar con Mercado Pago"
    const btnPagarFinal = document.getElementById('btnPagarFinal');
    if (btnPagarFinal) {
        btnPagarFinal.style.display = 'block';
    }
    
    // Hacer scroll al formulario
    setTimeout(() => {
        const carrito = document.getElementById('carrito');
        if (carrito) {
            carrito.scrollTo({ top: carrito.scrollHeight, behavior: 'smooth' });
        }
    }, 100);
}
// Funci√≥n para girar las cards
function girarCard(elemento) {
  const cardContenedor = elemento.closest('.card-contenedor');
  if (cardContenedor) {
    const estaGirada = cardContenedor.style.transform === 'rotateY(180deg)';
    cardContenedor.style.transform = estaGirada ? 'rotateY(0deg)' : 'rotateY(180deg)';
  }
}

// Tambi√©n girar al pasar mouse (opcional)
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.card-giratoria').forEach(card => {
    card.addEventListener('mouseenter', () => {
      // Opcional: gira autom√°ticamente al pasar mouse
      // card.querySelector('.card-contenedor').style.transform = 'rotateY(180deg)';
    });
    
    card.addEventListener('mouseleave', () => {
      // Opcional: vuelve al frente al sacar mouse  
      // card.querySelector('.card-contenedor').style.transform = 'rotateY(0deg)';
    });
  });
});
// 2. Ocultar formulario de datos del cliente (NUEVA)
function ocultarFormulario() {
    const datosCliente = document.getElementById('datosCliente');
    if (datosCliente) {
        datosCliente.style.display = 'none';
    }
    
    const btnContinuar = document.getElementById('btnContinuar');
    if (btnContinuar) {
        btnContinuar.style.display = 'block';
    }
    
    const btnPagarFinal = document.getElementById('btnPagarFinal');
    if (btnPagarFinal) {
        btnPagarFinal.style.display = 'none';
    }
}

// 3. Procesar pago completo (NUEVA)
async function pagarTodoJunto() {
    console.log("üõí Iniciando proceso de pago...");
    
    // 1. Validar que hay productos en el carrito
    if (carrito.length === 0) {
        alert("‚ùå El carrito est√° vac√≠o");
        return;
    }
    
    // 2. Obtener datos del formulario
    const nombreInput = document.querySelector('input[name="nombre"]');
    const apellidoInput = document.querySelector('input[name="apellido"]');
    const emailInput = document.querySelector('input[name="email"]');
    const telefonoInput = document.querySelector('input[name="telefono"]');
    
    if (!nombreInput || !apellidoInput || !emailInput) {
        alert("‚ùå Por favor completa todos los campos obligatorios");
        return;
    }
    
    const nombre = nombreInput.value.trim();
    const apellido = apellidoInput.value.trim();
    const emailCliente = emailInput.value.trim();
    const telefono = telefonoInput?.value?.trim() || "";
    
    if (!nombre || !apellido || !emailCliente) {
        alert("‚ùå Nombre, apellido y email son obligatorios");
        return;
    }
    
    // 3. Validar email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(emailCliente)) {
        alert("‚ùå Por favor ingresa un email v√°lido");
        return;
    }
    
    // 4. Generar un ID √∫nico para esta orden
    const orden_id = 'ORD_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // 5. Funci√≥n para convertir precio a n√∫mero
    function convertirPrecio(precio) {
        if (typeof precio === 'number') {
            return precio;
        }
        if (typeof precio === 'string') {
            // Remover s√≠mbolo $, comas y espacios
            const limpio = precio.replace(/[$\s,]/g, '').trim();
            const num = parseFloat(limpio);
            return isNaN(num) ? 0 : num;
        }
        return 0;
    }
    
    // 6. Funci√≥n para convertir cantidad a n√∫mero
    function convertirCantidad(cantidad) {
        const num = parseInt(cantidad);
        return isNaN(num) || num < 1 ? 1 : num;
    }
    
    // 7. Preparar el payload para el backend
    const itemsMP = []; // Para Mercado Pago
    const itemsCarrito = []; // Para Firestore
    
    let totalCalculado = 0;
    
    carrito.forEach(item => {
        // Convertir precios y cantidades
        const precio = convertirPrecio(item.precio);
        const cantidad = convertirCantidad(item.cantidad);
        const subtotal = precio * cantidad;
        totalCalculado += subtotal;
        
        // Item para Mercado Pago
        itemsMP.push({
            title: item.nombre + (item.talle ? ` (${item.talle})` : ""),
            quantity: cantidad,
            unit_price: precio,
            currency_id: "ARS"
        });
        
        // Item para Firestore (formato completo)
        itemsCarrito.push({
            nombre: item.nombre,
            precio: precio,
            cantidad: cantidad,
            talle: item.talle || "",
            id_base: item.id_base || "",
            grupo: item.grupo || "",
            subgrupo: item.subgrupo || "",
            subtotal: subtotal
        });
    });
    
    const payload = {
        email_vendedor: email,
        carrito: itemsCarrito,  // Enviar carrito completo con precios convertidos
        items_mp: itemsMP,      // Enviar tambi√©n items formateados para MP
        total: totalCalculado,
        cliente_nombre: `${nombre} ${apellido}`.trim(),
        cliente_email: emailCliente,
        cliente_telefono: telefono,
        orden_id: orden_id,
        url_retorno: window.location.href
    };
    
    console.log("üì¶ Payload para el pago:", payload);
    console.log("üí∞ Total calculado:", totalCalculado);
    console.log("üõí Items procesados:", itemsCarrito.length);
    
    // Debug: mostrar precios convertidos
    itemsCarrito.forEach((item, idx) => {
        console.log(`  ${idx+1}. ${item.nombre}: $${item.precio} x ${item.cantidad} = $${item.subtotal}`);
    });
    
    try {
        // Mostrar indicador de carga
        const btnPagarFinal = document.getElementById('btnPagarFinal');
        if (btnPagarFinal) {
            btnPagarFinal.disabled = true;
            btnPagarFinal.textContent = 'Procesando...';
        }
        
        // 8. Enviar al backend para crear la preferencia de pago
        const response = await fetch(`${URL_BACKEND}/pagar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Error HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log("‚úÖ Respuesta del backend:", data);
        
        // 9. Manejar la respuesta
        if (data.error) {
            alert("‚ùå Error: " + data.error);
        } else if (data.init_point) {
            // Guardar el ID de la orden en localStorage para referencia
            localStorage.setItem('ultima_orden_id', orden_id);
            localStorage.setItem('ultima_orden_data', JSON.stringify({
                fecha: new Date().toISOString(),
                items: carrito.length,
                total: totalCalculado,
                cliente: `${nombre} ${apellido}`,
                email: emailCliente
            }));
            
            // Redirigir a Mercado Pago
            console.log("‚û°Ô∏è Redirigiendo a Mercado Pago...");
            window.location.href = data.init_point;
        } else if (data.preference_id && window.mp) {
            // Usar SDK de Mercado Pago si est√° disponible
            localStorage.setItem('ultima_orden_id', orden_id);
            
            window.mp.checkout({
                preference: { id: data.preference_id },
                autoOpen: true
            });
        } else {
            console.warn("Respuesta inesperada del backend:", data);
            alert("‚ö†Ô∏è No se pudo procesar el pago. Intenta de nuevo.");
        }
        
    } catch (error) {
        console.error("üí• Error al procesar el pago:", error);
        alert("‚ùå Error al procesar el pago: " + error.message);
    } finally {
        // Restaurar bot√≥n
        const btnPagarFinal = document.getElementById('btnPagarFinal');
        if (btnPagarFinal) {
            btnPagarFinal.disabled = false;
            btnPagarFinal.textContent = 'Pagar con Mercado Pago';
        }
    }
}

// 4. Modificar la funci√≥n vaciarCarrito existente para que tambi√©n oculte el formulario
// Reemplaza tu funci√≥n vaciarCarrito existente con esta:
function vaciarCarrito() {
    carrito = [];
    actualizarCarrito();
    ocultarFormulario(); // Esto es lo nuevo que agregamos
}
    
// üëâ Mostrar/ocultar botones eliminar seg√∫n modo admin
function toggleModoAdmin(activo) {
  document.querySelectorAll(".btnEliminarCard").forEach(btn => {
    if (activo) {
      btn.classList.remove("d-none");
    } else {
      btn.classList.add("d-none");
    }
  });
}
    
function abrirConfigMercadoPago() {
    console.log("‚öôÔ∏è Redirigiendo a configuraci√≥n de Mercado Pago...");
    
    // üëâ Obtener la URL actual del vendedor (SU p√°gina)
    const urlRetorno = window.location.href;
    
    // üëâ Usamos URL_BACKEND para que siempre apunte al backend correcto
    const configUrl = `${URL_BACKEND}/conectar_mp?email=${encodeURIComponent(email)}&url_retorno=${encodeURIComponent(urlRetorno)}`;
    
    console.log("üîó Redirigiendo a:", configUrl);
    console.log("üìç URL de retorno (p√°gina del vendedor):", urlRetorno);
    
    window.location.href = configUrl;
}
    
async function eliminarProducto(id_base) {
  console.log("[ELIMINAR_PRODUCTO] üîî Click en bot√≥n eliminar ‚Üí id_base:", id_base);

  try {
    console.log("[ELIMINAR_PRODUCTO] üì° Enviando request al backend...");
    const resp = await fetch("https://mpagina.onrender.com/eliminar-producto", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id_base, email }) // üëà usa la variable global
    });

    console.log("[ELIMINAR_PRODUCTO] üì• Status HTTP:", resp.status);
    const data = await resp.json();
    console.log("[ELIMINAR_PRODUCTO] üìÑ Respuesta JSON:", data);

    if (data.status === "ok") {
      const card = document.querySelector(`[data-id="${id_base}"]`);
      if (card) {
        card.remove();
        console.log("[ELIMINAR_PRODUCTO] üóëÔ∏è Card eliminada del DOM:", id_base);
      } else {
        console.warn("[ELIMINAR_PRODUCTO] ‚ö†Ô∏è No se encontr√≥ la card en el DOM para id_base:", id_base);
      }
    } else {
      console.error("[ELIMINAR_PRODUCTO] ‚ùå Error reportado por backend:", data.error);
      alert("Error al eliminar producto: " + data.error);
    }
  } catch (err) {
    console.error("[ELIMINAR_PRODUCTO] üí• Excepci√≥n inesperada:", err);
    alert("Error al eliminar producto: " + err.message);
  }
}
    
// üëâ Optimizar imagen igual que Step0 ‚Üí resize a 300x180, WebP q=0.8
async function optimizarImagen(file) {
  console.log(`üìÇ [optimizarImagen] Iniciando optimizaci√≥n: ${file.name} (${file.size} bytes)`);

  const imgUrl = URL.createObjectURL(file);
  try {
    const img = await new Promise((resolve, reject) => {
      const image = new Image();
      image.onload = () => {
        console.log(`‚úÖ [optimizarImagen] Imagen cargada: ${image.width}x${image.height}px`);
        resolve(image);
      };
      image.onerror = reject;
      image.src = imgUrl;
    });

    const targetW = 500, targetH = 500;
    const canvas = document.createElement("canvas");
    canvas.width = targetW;
    canvas.height = targetH;
    const ctx = canvas.getContext("2d", { alpha: true });

    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = "high";
    ctx.clearRect(0, 0, targetW, targetH);

    const ratio = Math.min(targetW / img.width, targetH / img.height);
    const newW = Math.max(1, Math.round(img.width * ratio));
    const newH = Math.max(1, Math.round(img.height * ratio));
    const offsetX = Math.floor((targetW - newW) / 2);
    const offsetY = Math.floor((targetH - newH) / 2);

    console.log(`üìê [optimizarImagen] Escalado ‚Üí newW=${newW}, newH=${newH}, offsetX=${offsetX}, offsetY=${offsetY}`);
    ctx.drawImage(img, offsetX, offsetY, newW, newH);

    const blob = await new Promise((resolve, reject) => {
      canvas.toBlob(b => {
        if (b && b.size > 0) {
          console.log(`‚úÖ [optimizarImagen] Blob generado (${b.size} bytes)`);
          resolve(b);
        } else {
          reject(new Error("‚ùå No se pudo generar WebP"));
        }
      }, "image/webp", 0.8);
    });

    return blob;
  } finally {
    URL.revokeObjectURL(imgUrl);
    console.log(`üßπ [optimizarImagen] URL revocada`);
  }
}

// üëâ Preview inmediato de la foto optimizada
document.getElementById("inputFoto").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  try {
    const blobOptimizado = await optimizarImagen(file);
    window.fotoOptimizada = blobOptimizado;

    const urlPreview = URL.createObjectURL(blobOptimizado);
    const imgPreview = document.getElementById("previewFoto");
    imgPreview.src = urlPreview;
    imgPreview.classList.remove("d-none");

    console.log("üëÅÔ∏è Preview inmediato mostrado");
  } catch (err) {
    console.error("üí• Error al optimizar imagen:", err);
    alert("‚ùå No se pudo optimizar la imagen");
  }
});

document.getElementById("btnConfirmarProd").addEventListener("click", async () => {
  const email = "ferj.9622@gmail.com";
  if (!email) {
    alert("‚ùå No hay email de admin, no se puede guardar");
    return;
  }

  try {
    // üî• NUEVA L√ìGICA: Obtener precio anterior para OFERTAS
    let precioViejo = 0;
    let precioAnteriorParaEnviar = 0; // üî• NUEVO: Variable para enviar al backend
    
    if (window.productoEditandoId) {
      const productoExistente = window.todosLosProductos?.find(p => p.id_base === window.productoEditandoId);
      if (productoExistente) {
        precioViejo = parseFloat(productoExistente.precio) || 0;
        console.log(`üí∞ Precio anterior encontrado: $${precioViejo}`);
        
        // üî• NUEVO: Determinar si debemos guardar precio_anterior
        // Solo si el precio VIEJO es MAYOR que el NUEVO (es una oferta)
        const precioNuevo = parseFloat(document.getElementById("precioProd").value);
        
        if (!isNaN(precioNuevo) && precioViejo > precioNuevo) {
          // ¬°Es una oferta! Guardar precio anterior
          precioAnteriorParaEnviar = precioViejo;
          console.log(`üî• OFERTA DETECTADA: $${precioViejo} ‚Üí $${precioNuevo} (Ahorro: $${(precioViejo - precioNuevo).toFixed(2)})`);
        } else if (precioViejo < precioNuevo) {
          // El precio subi√≥, NO guardar precio anterior
          precioAnteriorParaEnviar = 0;
          console.log(`üìà Precio aument√≥: $${precioViejo} ‚Üí $${precioNuevo} (NO es oferta)`);
        } else {
          // Mismo precio o precio nuevo inv√°lido
          precioAnteriorParaEnviar = 0;
          console.log(`üìä Precio sin cambios: $${precioViejo}`);
        }
      }
    }

    // 1. Subir foto principal optimizada
    let foto_url = "";
    if (window.fotoOptimizada) {
      const formData = new FormData();
      formData.append("file", window.fotoOptimizada, "producto.jpg");
      formData.append("email", email);

      console.log("üì° Subiendo foto principal...");
      const respFoto = await fetch("https://mpagina.onrender.com/subir-foto", {
        method: "POST",
        body: formData
      });

      if (!respFoto.ok) {
        const text = await respFoto.text();
        throw new Error(`Error al subir foto: ${respFoto.status} ${text}`);
      }

      const fotoData = await respFoto.json();
      foto_url = fotoData.url || "";
      console.log("‚úÖ Foto principal subida:", foto_url);
    } else if (window.productoEditandoId) {
      const productoExistente = window.todosLosProductos?.find(p => p.id_base === window.productoEditandoId);
      foto_url = productoExistente?.imagen_url || "";
      console.log("üîÑ Manteniendo foto principal existente:", foto_url);
    }

    // üî• 2. Subir fotos adicionales
    const fotosAdicionalesUrls = [];
    
    // Primero, incluir fotos existentes si estamos editando
    if (window.fotosAdicionalesExistentes && window.fotosAdicionalesExistentes.length > 0) {
      fotosAdicionalesUrls.push(...window.fotosAdicionalesExistentes);
      console.log(`üîÑ Manteniendo ${window.fotosAdicionalesExistentes.length} fotos adicionales existentes`);
    }
    
    // Luego, subir nuevas fotos adicionales
    const fotosInput = document.getElementById('fotosAdicionales');
    if (fotosInput && fotosInput.files && fotosInput.files.length > 0) {
      console.log(`üì∏ Subiendo ${fotosInput.files.length} nuevas fotos adicionales...`);
      
      for (let i = 0; i < fotosInput.files.length; i++) {
        try {
          const file = fotosInput.files[i];
          
          // Optimizar cada foto adicional
          let blobOptimizado;
          try {
            blobOptimizado = await optimizarImagen(file);
          } catch (e) {
            console.warn(`‚ö†Ô∏è No se pudo optimizar foto ${i+1}, subiendo original:`, e);
            blobOptimizado = file; // Usar archivo original si falla la optimizaci√≥n
          }
          
          const formData = new FormData();
          formData.append("file", blobOptimizado, `adicional_${Date.now()}_${i}.jpg`);
          formData.append("email", email);

          const resp = await fetch("https://mpagina.onrender.com/subir-foto", {
            method: "POST",
            body: formData
          });

          if (!resp.ok) {
            const text = await resp.text();
            console.warn(`‚ö†Ô∏è Error subiendo foto adicional ${i+1}: ${resp.status} ${text}`);
            continue; // Continuar con las dem√°s fotos
          }

          const data = await resp.json();
          if (data.url) {
            fotosAdicionalesUrls.push(data.url);
            console.log(`‚úÖ Foto adicional ${i+1} subida: ${data.url.substring(0, 50)}...`);
          }
        } catch (err) {
          console.error(`‚ùå Error procesando foto adicional ${i+1}:`, err);
          // Continuar con las dem√°s fotos
        }
      }
    }

    console.log(`üìä Total fotos adicionales procesadas: ${fotosAdicionalesUrls.length}`);

    // 3. Obtener datos del formulario
    const nombre = document.getElementById("nombreProd").value.trim();
    const precioNuevo = parseFloat(document.getElementById("precioProd").value);
    const descripcion = document.getElementById("descripcionProd").value.trim();
    const tallesRaw = document.getElementById("tallesProd").value.trim();
    const grupo = document.getElementById("grupoProd")?.value.trim() || "General";
    const subgrupo = document.getElementById("subgrupoProd")?.value.trim() || "general";

    if (!nombre || isNaN(precioNuevo) || precioNuevo <= 0 || !grupo) {
      alert("‚ùå Faltan campos obligatorios: nombre/grupo/precio");
      return;
    }

    // 4. Procesar stock
    let stockPorTalle = {};
    const talles = tallesRaw ? tallesRaw.split(",").map(t => t.trim()).filter(Boolean) : [];
    
    if (talles.length > 0) {
      const stockTalleInput = document.getElementById("stockPorTalle").value.trim();
      
      if (stockTalleInput) {
        stockTalleInput.split(",").forEach(item => {
          const parts = item.split(":").map(s => s.trim());
          if (parts.length >= 2) {
            const talle = parts[0];
            const stock = parseInt(parts[1]) || 0;
            if (talle && !isNaN(stock)) {
              stockPorTalle[talle] = stock;
            }
          }
        });
        
        talles.forEach(talle => {
          if (stockPorTalle[talle] === undefined) {
            stockPorTalle[talle] = 0;
          }
        });
      } else {
        talles.forEach(talle => stockPorTalle[talle] = 0);
      }
    } else {
      const stockGeneral = parseInt(document.getElementById("stockGeneral").value) || 0;
      stockPorTalle = {"unico": stockGeneral};
    }

    console.log("üì¶ Stock procesado:", stockPorTalle);

    // üî• 5. MODIFICADO: Guardar en localStorage SOLO para referencia local (opcional)
    // Esto es ahora redundante pero lo mantenemos por compatibilidad
    if (window.productoEditandoId && precioViejo > precioNuevo) {
      try {
        const historial = JSON.parse(localStorage.getItem('historial_precios') || '{}');
        historial[window.productoEditandoId] = precioViejo;
        localStorage.setItem('historial_precios', JSON.stringify(historial));
        console.log(`üí∞ Precio anterior guardado en localStorage: $${precioViejo} (backup)`);
      } catch(e) {
        console.log("‚ö†Ô∏è Error guardando en localStorage:", e);
      }
    }

    // 6. üî• NUEVO: Crear objeto producto CON precio_anterior
    const producto = {
      nombre: nombre,
      precio: precioNuevo,
      descripcion: descripcion || "",
      talles: talles,
      grupo: grupo,
      subgrupo: subgrupo,
      stock_por_talle: stockPorTalle,
      imagen_url: foto_url,
      fotos_adicionales: fotosAdicionalesUrls,
      // üî• NUEVO: Incluir precio_anterior solo si es una oferta v√°lida
      precio_anterior: precioAnteriorParaEnviar
    };

    // 7. Preparar payload
    const esEdicion = window.productoEditandoId ? true : false;
    const payload = {
      producto: producto,
      email: email,
      es_edicion: esEdicion
    };

    // Si es edici√≥n, tambi√©n enviar id_base DENTRO del producto
    if (esEdicion) {
      payload.producto.id_base = window.productoEditandoId;
      console.log("üîÑ Modo EDICI√ìN para ID:", window.productoEditandoId);
      console.log(`üí∞ precio_anterior a enviar: $${precioAnteriorParaEnviar} ${precioAnteriorParaEnviar > 0 ? '(OFERTA)' : '(sin oferta)'}`);
    } else {
      console.log("‚ûï Modo CREACI√ìN de nuevo producto");
      // Para productos nuevos, precio_anterior siempre ser√° 0
      producto.precio_anterior = 0;
    }

    console.log("üì§ Payload para backend:", JSON.stringify(payload, null, 2));

    // 8. Enviar al backend
    const endpoint = "https://mpagina.onrender.com/guardar-producto";
    
    const respGuardar = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!respGuardar.ok) {
      const text = await respGuardar.text();
      console.error("‚ùå Error del servidor:", text);
      throw new Error(`Error al guardar producto: ${respGuardar.status} ${text}`);
    }

    const data = await respGuardar.json();
    console.log("üì© Respuesta backend:", data);

    if (data.status === "ok") {
      const mensaje = esEdicion ? 
        `‚úÖ Producto actualizado correctamente (${fotosAdicionalesUrls.length} fotos adicionales)` : 
        `‚úÖ Producto creado correctamente (${fotosAdicionalesUrls.length} fotos adicionales)`;
      
      // üî• NUEVO: Mostrar mensaje de oferta basado en precio_anterior del backend
      const tieneOferta = data.resultado?.tiene_oferta || precioAnteriorParaEnviar > 0;
      const precioAnteriorBackend = data.resultado?.precio_anterior || precioAnteriorParaEnviar;
      
      if (tieneOferta && precioAnteriorBackend > 0) {
        const descuento = Math.round(((precioAnteriorBackend - precioNuevo) / precioAnteriorBackend) * 100);
        alert(`${mensaje}\nüî• ¬°OFERTA DETECTADA! -${descuento}% de descuento`);
        
        // Mostrar en consola para debug
        console.log(`üéØ OFERTA CONFIRMADA: Antes $${precioAnteriorBackend} ‚Üí Ahora $${precioNuevo} (-${descuento}%)`);
      } else {
        alert(mensaje);
        console.log(`üìä Producto guardado sin oferta: $${precioNuevo}`);
      }
      
      // 9. Limpiar formulario
      resetearFormularioAdmin();
      
      // 10. Limpiar variables temporales
      window.fotosAdicionalesExistentes = null;
      
      // 11. Ocultar formulario
      document.getElementById("adminCard").classList.add("d-none");
      
      // 12. Refrescar productos
      setTimeout(() => {
        if (typeof cargarProductos === "function") {
          cargarProductos();
        } else {
          location.reload();
        }
      }, 1000);
      
    } else {
      console.error("‚ùå Error al guardar producto:", data);
      alert("‚ùå " + (data.error || data.message || "Error al guardar producto"));
    }
  } catch (err) {
    console.error("üí• Error en flujo de confirmaci√≥n:", err);
    alert("‚ùå Error al guardar producto: " + err.message);
  }
});

    
function salirAdmin() {
  console.log("üö™ Saliendo de modo admin, limpiando token...");

  // Desactivar modo admin y limpiar token
  window.modoAdmin = false;
  window.tokenAdmin = null;

  // Limpiar la URL para quitar el ?token=...
  history.replaceState(null, "", "index.html");

  // üî• NUEVO: Ocultar bot√≥n admin flotante
  const loginToggleBtn = document.getElementById("loginToggleBtn");
  if (loginToggleBtn) {
    loginToggleBtn.style.display = "none";
    console.log("‚úÖ Bot√≥n admin flotante ocultado");
  }
  
  // Refrescar productos para que se oculten los botones ‚úé
  if (window.todosLosProductos) {
    const cont = document.getElementById("productos");
    if (cont) {
      cont.innerHTML = "";
      window.todosLosProductos.forEach(p => cont.appendChild(renderProducto(p)));
      console.log("‚úÖ Productos re-renderizados en modo p√∫blico, total:", cont.children.length);
    } else {
      console.warn("‚ö†Ô∏è No se encontr√≥ el contenedor #productos al salir de admin");
    }
  }

  // Ocultar bot√≥n de logout
  const logoutWrapper = document.getElementById("logoutAdminWrapper");
  if (logoutWrapper) {
    logoutWrapper.style.display = "none";
    console.log("‚úÖ Bot√≥n de logout ocultado");
  } else {
    console.warn("‚ö†Ô∏è No se encontr√≥ #logoutAdminWrapper en el DOM");
  }

  // Ocultar paneles de administraci√≥n
  const adminCard = document.getElementById("adminCard");
  if (adminCard) {
    adminCard.classList.add("d-none");
    console.log("‚úÖ adminCard ocultado");
  }

  const configurarMP = document.getElementById("configurarMP");
  if (configurarMP) {
    configurarMP.classList.add("d-none");
    console.log("‚úÖ configurarMP ocultado");
  }
}

// Mostrar el bot√≥n solo si modoAdmin est√° activo
if (window.modoAdmin) {
  const logoutWrapper = document.getElementById("logoutAdminWrapper");
  if (logoutWrapper) {
    logoutWrapper.style.display = "block";
    console.log("üîë Modo admin activo, mostrando bot√≥n de logout");
  }

  // Mostrar paneles de administraci√≥n
  const adminCard = document.getElementById("adminCard");
  if (adminCard) {
    adminCard.classList.remove("d-none");
    console.log("üîë adminCard mostrado");
  }

  const configurarMP = document.getElementById("configurarMP");
  if (configurarMP) {
    configurarMP.classList.remove("d-none");
    console.log("üîë configurarMP mostrado");
  }
}

function renderPagina(pagina, productosFiltrados) {
  const cont = document.getElementById("productos"); // üëà agregar esto
  totalPaginas = Math.ceil(productosFiltrados.length / itemsPorPagina);

  const inicio = (pagina - 1) * itemsPorPagina;
  const fin = inicio + itemsPorPagina;
  const productosPagina = productosFiltrados.slice(inicio, fin);

  cont.innerHTML = "";
  productosPagina.forEach(p => cont.appendChild(renderProducto(p)));
}


function renderPaginacion(productosFiltrados) {
  const pagDiv = document.getElementById("paginacion");
  pagDiv.innerHTML = "";
  totalPaginas = Math.ceil(productosFiltrados.length / itemsPorPagina);

  for (let i = 1; i <= totalPaginas; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.className = "btn btn-light mx-1";
    btn.onclick = () => renderPagina(i, productosFiltrados);
    pagDiv.appendChild(btn);
  }
}

// const EMAIL_VENDEDOR = urlParams.get("usuario") || "usuario@ejemplo.com";
let urlProductos = `https://mpagina.onrender.com/api/productos?usuario=${encodeURIComponent(email)}`;
// Si est√°s en modo admin y ten√©s token, lo incluimos
if (window.modoAdmin && window.tokenAdmin) {
  urlProductos += `&token=${encodeURIComponent(window.tokenAdmin)}`;
}

console.log("üì° Solicitando productos desde:", urlProductos);

console.log("üîç [CARGA-PRODUCTOS] INICIANDO... ==============================");
console.log("üì° Solicitando productos desde:", urlProductos);

fetch(urlProductos)
  .then(r => {
    console.log("üì• Respuesta HTTP recibida, status:", r.status);
    if (!r.ok) {
      throw new Error("HTTP " + r.status);
    }
    return r.json();
  })
  .then(lista => {
    console.log("‚úÖ Datos JSON recibidos:", lista);
    console.log("üìä Tipo de datos:", typeof lista);
    console.log("üìä Es array?:", Array.isArray(lista));
    console.log("üìä N√∫mero de elementos:", lista.length);
    
    if (!Array.isArray(lista)) {
      console.log("‚ùå ERROR: La respuesta NO es un array:", lista);
      return;
    }
    
    // üî• DIAGN√ìSTICO DETALLADO DE CADA PRODUCTO
    console.log("\nüîç ANALIZANDO CADA PRODUCTO:");
    lista.forEach((prod, idx) => {
      console.log(`\n   ${idx+1}. ${prod.nombre || 'Sin nombre'} (${prod.id_base || 'Sin ID'}):`);
      console.log(`       - Precio: $${prod.precio || 0} (tipo: ${typeof prod.precio})`);
      console.log(`       - Precio anterior: ${prod.precio_anterior || 'NO TIENE'} (tipo: ${typeof prod.precio_anterior})`);
      console.log(`       - ¬øCampo "precio_anterior" existe?: ${'precio_anterior' in prod}`);
      
      // Mostrar todos los campos del producto
      console.log(`       - Todos los campos:`, Object.keys(prod).join(', '));
      
      // Mostrar producto espec√≠fico que editamos
      if (prod.id_base === "campera_20251214_camperas_71551a") {
        console.log(`\n   üéØ ¬°ESTE ES EL PRODUCTO EDITADO!`);
        console.log(`       - Datos completos:`, JSON.stringify(prod, null, 2));
        console.log(`       - ¬øprecio_anterior > precio?: ${prod.precio_anterior > prod.precio}`);
        
        // Si no tiene precio_anterior, mostrar qu√© campos s√≠ tiene
        if (!prod.precio_anterior) {
          console.log(`       ‚ö†Ô∏è ¬°NO TIENE PRECIO_ANTERIOR! Campos disponibles:`);
          Object.entries(prod).forEach(([key, value]) => {
            console.log(`           ${key}: ${value} (${typeof value})`);
          });
        }
      }
    });
    
    // Contar productos con oferta
    const productosConOferta = lista.filter(p => p.precio_anterior > 0 && p.precio_anterior > p.precio);
    console.log(`\nüìä RESUMEN: ${productosConOferta.length} productos con oferta de ${lista.length} total`);
    
    if (productosConOferta.length > 0) {
      console.log("üî• Productos con oferta detectados:");
      productosConOferta.forEach(p => {
        const descuento = Math.round(((p.precio_anterior - p.precio) / p.precio_anterior) * 100);
        console.log(`   - ${p.nombre} (${p.id_base}): $${p.precio_anterior} ‚Üí $${p.precio} (-${descuento}%)`);
      });
    } else {
      console.log("‚ùå NO SE DETECTARON PRODUCTOS CON OFERTA");
      console.log("   - Posible problema: El backend no est√° devolviendo precio_anterior");
    }
    
    console.log("\nüîç [CARGA-PRODUCTOS] FIN DIAGN√ìSTICO =======================\n");

    // ORDENAR LOS PRODUCTOS: primero con stock, luego por precio
    const productosOrdenados = Array.isArray(lista) ? lista : [];
    
    productosOrdenados.sort((a, b) => {
      // 1. Primero verificar si tienen stock
      const stockA = (a.stock_por_talle && Object.values(a.stock_por_talle).some(v => v > 0)) || 
                     (a.stock && a.stock > 0);
      const stockB = (b.stock_por_talle && Object.values(b.stock_por_talle).some(v => v > 0)) || 
                     (b.stock && b.stock > 0);
      
      // Si A tiene stock y B no, A va primero
      if (stockA && !stockB) return -1;
      // Si B tiene stock y A no, B va primero
      if (!stockA && stockB) return 1;
      
      // 2. Si ambos tienen o no tienen stock, ordenar por precio (menor a mayor)
      return (a.precio || 0) - (b.precio || 0);
    });
    
    window.todosLosProductos = productosOrdenados;
    console.log("üåê Productos recibidos y ordenados:", window.todosLosProductos.length);

    // üî• VERIFICAR QUE EL PRODUCTO EDITADO EST√Å EN EL ARRAY
    const productoEditadoEnArray = window.todosLosProductos.find(p => p.id_base === "campera_20251214_camperas_71551a");
    if (productoEditadoEnArray) {
      console.log("‚úÖ Producto editado encontrado en array global:");
      console.log("   - Nombre:", productoEditadoEnArray.nombre);
      console.log("   - Precio anterior:", productoEditadoEnArray.precio_anterior);
      console.log("   - Precio:", productoEditadoEnArray.precio);
      console.log("   - ¬øTiene oferta?:", productoEditadoEnArray.precio_anterior > productoEditadoEnArray.precio);
      
      // üî• FORZAR precio_anterior si no lo tiene
      if (!productoEditadoEnArray.precio_anterior || productoEditadoEnArray.precio_anterior <= productoEditadoEnArray.precio) {
        console.log("‚ö†Ô∏è Producto editado NO tiene oferta en array global, forzando...");
        // Recuperar de localStorage temporalmente
        const historial = JSON.parse(localStorage.getItem('historial_precios') || '{}');
        if (historial["campera_20251214_camperas_71551a"]) {
          productoEditadoEnArray.precio_anterior = historial["campera_20251214_camperas_71551a"];
          console.log("   - Precio anterior recuperado de localStorage:", productoEditadoEnArray.precio_anterior);
        }
      }
    } else {
      console.log("‚ùå Producto editado NO encontrado en array global");
    }

    // üî• AGREGAR SUGERENCIAS SIMPLES PARA FORMULARIO ADMIN
    setTimeout(() => {
      // Extraer grupos y subgrupos √∫nicos
      const gruposUnicos = [...new Set(productosOrdenados.map(p => p.grupo).filter(Boolean))];
      const subgruposUnicos = [...new Set(productosOrdenados.map(p => p.subgrupo).filter(Boolean))];
      
      // Llenar datalist de grupos
      const datalistGrupos = document.getElementById('grupos-sugeridos');
      if (datalistGrupos && gruposUnicos.length > 0) {
        datalistGrupos.innerHTML = '';
        gruposUnicos.forEach(grupo => {
          const option = document.createElement('option');
          option.value = grupo;
          datalistGrupos.appendChild(option);
        });
        console.log(`‚úÖ ${gruposUnicos.length} grupos para sugerencias`);
      }
      
      // Llenar datalist de subgrupos
      const datalistSubgrupos = document.getElementById('subgrupos-sugeridos');
      if (datalistSubgrupos && subgruposUnicos.length > 0) {
        datalistSubgrupos.innerHTML = '';
        subgruposUnicos.forEach(subgrupo => {
          const option = document.createElement('option');
          option.value = subgrupo;
          datalistSubgrupos.appendChild(option);
        });
        console.log(`‚úÖ ${subgruposUnicos.length} subgrupos para sugerencias`);
      }
    }, 100);

    const cont = document.getElementById("productos");
    const contGrupos = document.getElementById("panelGrupos");
    const contSub = document.getElementById("panelSubcategorias");

    if (!cont) {
      console.warn("‚ö†Ô∏è No existe #productos en el DOM");
      return;
    }
    if (!contGrupos || !contSub) {
      console.warn("‚ö†Ô∏è Faltan paneles #panelGrupos o #panelSubcategorias en el DOM");
    }

    const grupos = [...new Set(window.todosLosProductos.map(p => p.grupo).filter(Boolean))];
    console.log("üìÇ Grupos detectados:", grupos);

    if (contGrupos) {
      contGrupos.innerHTML = ""; // limpiar antes de insertar
      grupos.forEach(g => {
        const btn = document.createElement("button");
        btn.className = "btn-grupo";
        btn.textContent = g;
        btn.addEventListener("click", (e) => {
          console.log("üü¢ Click en bot√≥n grupo:", g);
          mostrarGrupo(g, e);
        });
        contGrupos.appendChild(btn);
        console.log("‚ûï Bot√≥n grupo creado:", g);
      });
    }

    // Render inicial: primer grupo y subgrupo
    const primerGrupo = grupos[0];
    const subgruposPrimer = [...new Set(window.todosLosProductos
      .filter(p => p.grupo === primerGrupo)
      .map(p => p.subgrupo).filter(Boolean))];

    console.log("üéØ Primer grupo:", primerGrupo);
    console.log("üìÇ Subgrupos del primer grupo:", subgruposPrimer);

    if (primerGrupo) {
      mostrarGrupo(primerGrupo, null, true);
      if (subgruposPrimer.length > 0) {
        console.log("‚û°Ô∏è Render inicial con subgrupo:", subgruposPrimer[0]);
        filtrarSubcategoria(primerGrupo, subgruposPrimer[0]);
      }
    }

    console.log("‚úÖ Render inicial completado");
  })
  .catch(err => {
    console.error("üí• Error cargando productos:", err);
    const cont = document.getElementById("productos");
    if (cont) cont.innerHTML = "<p>Error al cargar productos.</p>";
  });
// üî• FUNCI√ìN DE EMERGENCIA: Forzar oferta si el backend no la devuelve
function forzarOfertaSiEsNecesario() {
  if (!window.todosLosProductos) return;
  
  // Lista de IDs que sabemos que tienen oferta
  const productosConOfertaConocida = [
    { id: "campera_20251214_camperas_71551a", precio_anterior: 2, precio_actual: 1 }
  ];
  
  productosConOfertaConocida.forEach(productoInfo => {
    const producto = window.todosLosProductos.find(p => p.id_base === productoInfo.id);
    if (producto && (!producto.precio_anterior || producto.precio_anterior <= producto.precio)) {
      console.log(`üî• Forzando oferta para ${producto.nombre}: $${productoInfo.precio_anterior} ‚Üí $${productoInfo.precio_actual}`);
      producto.precio_anterior = productoInfo.precio_anterior;
      
      // Actualizar en el DOM inmediatamente
      setTimeout(() => {
        const cardExistente = document.querySelector(`[data-id="${productoInfo.id}"]`);
        if (cardExistente) {
          cardExistente.remove();
          const nuevaCard = renderProducto(producto);
          document.getElementById("productos").appendChild(nuevaCard);
          console.log(`üîÑ Card actualizada: ${producto.nombre}`);
        }
      }, 1000);
    }
  });
}

// Llama a esta funci√≥n despu√©s de cargar productos
setTimeout(forzarOfertaSiEsNecesario, 2000);    
function mostrarGrupo(nombre, event, auto = false) {
  console.log("üü¶ mostrarGrupo llamado con:", { nombre, auto });

  const cont = document.getElementById("productos");
  if (!cont) {
    console.warn("‚ö†Ô∏è No existe #productos en el DOM");
    return;
  }

  // Resetear botones de grupo
  document.querySelectorAll('.btn-grupo').forEach(btn => btn.classList.remove('active'));
  if (event?.target) {
    event.target.classList.add('active');
    console.log("üëâ Bot√≥n de grupo marcado:", event.target.textContent);
  }

  const panel = document.getElementById('panelSubcategorias');
  if (!panel) {
    console.warn("‚ö†Ô∏è No existe #panelSubcategorias en el DOM");
    return;
  }
  panel.innerHTML = "";

  // Normalizar y guardar grupo activo
  const grupoCanon = String(nombre || "").trim();
  window.currentGrupo = grupoCanon.toLowerCase();
  console.log("üéØ Grupo activo (canon):", grupoCanon);

  const productosGrupo = (window.todosLosProductos || []).filter(
    p => String(p.grupo || "").toLowerCase() === grupoCanon.toLowerCase()
  );
  console.log("üì¶ Productos encontrados para grupo:", productosGrupo.length);

  const subcategorias = [...new Set(
    productosGrupo.map(p => p.subgrupo).filter(s => s && String(s).toLowerCase() !== 'general')
  )];
  console.log("üìÇ Subcategor√≠as detectadas:", subcategorias);

  // Crear botones de subgrupo
  subcategorias.forEach(sub => {
    const btn = document.createElement('button');
    btn.textContent = sub;
    btn.className = 'btn-subgrupo';
    btn.addEventListener("click", (e) => mostrarSubgrupo(sub, e));
    panel.appendChild(btn);
    console.log("‚ûï Bot√≥n subgrupo creado:", sub);
  });

  // üîÅ Usar paginaci√≥n en lugar de volcar todo
  renderPagina(1, productosGrupo);
  renderPaginacion(productosGrupo);

  // üî• ANIMACI√ìN MEJORADA para panel subcategor√≠as
  if (subcategorias.length > 0) {
    if (!auto) {
      // Forzar reflow para animaci√≥n
      void panel.offsetWidth;
      panel.classList.remove('oculta');
      console.log("üìÇ Panel subcategorias visible (con animaci√≥n)");
      
      // Asegurar que est√© visible antes de ajustar posici√≥n
      setTimeout(() => {
        ajustarPosicionesPaneles();
      }, 10);
    } else {
      // Forzar reflow para animaci√≥n
      void panel.offsetWidth;
      panel.classList.add('oculta');
      console.log("üìÇ Panel subcategorias oculto (auto, con animaci√≥n)");
    }
  } else {
    // Forzar reflow para animaci√≥n
    void panel.offsetWidth;
    panel.classList.add('oculta');
    console.log("üìÇ Grupo sin subcategor√≠as (oculto con animaci√≥n)");
  }

  console.log("‚úÖ Productos renderizados con paginaci√≥n en #productos");
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
// Extra: log de clicks en botones
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("btn-grupo")) {
    console.log("üü¢ Click en bot√≥n grupo:", e.target.textContent);
  }
  if (e.target.classList.contains("btn-subgrupo")) {
    console.log("üü¢ Click en bot√≥n subgrupo:", e.target.textContent);
  }
});

function filtrarSubcategoria(grupo, subgrupo) {
  console.log("üü® filtrarSubcategoria llamada con:", { grupo, subgrupo });

  const cont = document.getElementById("productos");
  if (!cont) {
    console.warn("‚ö†Ô∏è No existe #productos en el DOM");
    return;
  }
  
  // Limpiar con fade out
  cont.style.opacity = '0.5';
  cont.style.transition = 'opacity 0.2s ease';
  
  setTimeout(() => {
    cont.innerHTML = "";

    const grupoCanon = String(grupo || "").trim();
    const subCanon = String(subgrupo || "").trim();
    console.log("üéØ Grupo canon:", grupoCanon, " | Subgrupo canon:", subCanon || `General_${grupoCanon}`);

    // Filtrar productos
    let productosFiltrados;
    if (subCanon) {
      productosFiltrados = window.todosLosProductos.filter(p =>
        String(p.grupo || "").toLowerCase() === grupoCanon.toLowerCase() &&
        String(p.subgrupo || "").toLowerCase() === subCanon.toLowerCase()
      );
    } else {
      const subgrupoGeneral = `General_${grupoCanon}`;
      productosFiltrados = window.todosLosProductos.filter(p =>
        String(p.grupo || "").toLowerCase() === grupoCanon.toLowerCase() &&
        String(p.subgrupo || "").toLowerCase() === subgrupoGeneral.toLowerCase()
      );
    }

    console.log("üì¶ Productos filtrados:", productosFiltrados.length);

    // üîÅ Usar paginaci√≥n en lugar de volcar todo
    renderPagina(1, productosFiltrados);
    renderPaginacion(productosFiltrados);

    console.log("‚úÖ Productos renderizados con paginaci√≥n en #productos");
    console.log("üì• Hijos actuales en #productos:", cont.children.length);

    // Fade in
    cont.style.opacity = '1';
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, 200);
}


window.onload = function() {
  const panelSubcategorias = document.getElementById('panelSubcategorias');
  const panelGrupos = document.getElementById('panelGrupos');
  
  // Inicializar ocultos con animaci√≥n
  if (panelSubcategorias) {
    panelSubcategorias.classList.add('oculta');
  }
  if (panelGrupos) {
    panelGrupos.classList.add('oculta');
  }

  // Carrito toggle
  document.getElementById('toggleCarrito').onclick = function() {
    const carritoDiv = document.getElementById('carrito');
    if (!carritoDiv) return;
    carritoDiv.style.display = carritoDiv.style.display === 'none' ? 'block' : 'none';
  };
  
  // Ajustar posiciones despu√©s de que todo cargue
  setTimeout(() => {
    ajustarPosicionesPaneles();
  }, 300);
};

let carrito = [];

function agregarAlCarritoDOM(nombre, idPrecioSpan, idCantidad, id_base, grupo = "", subgrupo = "") {
  const cantidadInput = document.getElementById(idCantidad);
  const precioSpan = document.getElementById(idPrecioSpan);
  const talleSelect = document.getElementById(`talle_${id_base}`);
  
  if (!cantidadInput || !precioSpan) {
    alert("‚ùå Error: No se pudieron obtener los datos del producto");
    return;
  }
  
  // üî• OBTENER TALLE (obligatorio si el producto tiene talles)
  const talleElegido = talleSelect?.value || "unico";
  
  // Verificar stock para el talle seleccionado
  let stockDisponible = 0;
  const stockPorTalle = window[`stock_por_talle_${id_base}`];
  
  if (stockPorTalle) {
    stockDisponible = stockPorTalle[talleElegido] || 0;
  }
  
  if (stockDisponible <= 0) {
    alert("‚ùå No hay stock disponible" + (talleElegido !== "unico" ? ` para el talle ${talleElegido}` : ""));
    return;
  }
  
  const cantidad = parseInt(cantidadInput.value) || 1;
  
  if (cantidad > stockDisponible) {
    alert(`‚ùå Solo hay ${stockDisponible} unidades disponibles${talleElegido !== "unico" ? ` para el talle ${talleElegido}` : ""}`);
    cantidadInput.value = stockDisponible;
    return;
  }
  
  const precio = parseFloat(precioSpan.textContent.replace("$", "").replace(",", "")) || 0;
  
  // Buscar si ya existe en el carrito (mismo producto y mismo talle)
  const existente = carrito.find(item => 
    item.id_base === id_base && 
    item.talle === talleElegido
  );
  
  if (existente) {
    const nuevoTotal = existente.cantidad + cantidad;
    
    if (nuevoTotal > stockDisponible) {
      alert(`‚ùå No puedes llevar m√°s de ${stockDisponible} unidades${talleElegido !== "unico" ? ` del talle ${talleElegido}` : ""}`);
      return;
    }
    
    existente.cantidad = nuevoTotal;
  } else {
    const nuevoItem = { 
      nombre, 
      precio, 
      cantidad, 
      id_base, 
      talle: talleElegido,
      grupo, 
      subgrupo 
    };
    carrito.push(nuevoItem);
  }
  
  actualizarCarrito();
  console.log(`‚úÖ Producto agregado al carrito: ${nombre} ${talleElegido !== "unico" ? `(Talle: ${talleElegido})` : ""}`);
}

function loginAdmin(event) {
  event.preventDefault();

  const usuario = document.getElementById("usuario_login").value.trim();
  const clave = document.getElementById("clave_login").value.trim();

  if (!usuario || !clave) {
    alert("‚ùå Usuario y clave requeridos");
    return;
  }

  const btn = event.target.querySelector('button[type="submit"]');
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'Entrando...';
  }

  fetch("https://mpagina.onrender.com/login-admin", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ usuario, clave })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok" && data.token) {
        alert("‚úÖ Acceso concedido");
        
        // üî• NUEVO: Ocultar bot√≥n admin flotante al entrar
        const loginToggleBtn = document.getElementById("loginToggleBtn");
        if (loginToggleBtn) {
          loginToggleBtn.style.display = "none";
        }
        
        // Ocultar formulario flotante
        const loginForm = document.getElementById("loginFloatingForm");
        if (loginForm) {
          loginForm.style.display = "none";
        }
        
        // redirigir al preview din√°mico con token en la URL
        location.href = `index.html?token=${data.token}`;
      } else {
        alert("‚ùå " + data.message);
      }
    })
    .catch(() => {
      alert("‚ùå Error al intentar login");
    })
    .finally(() => {
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Entrar';
      }
    });
}

function eliminarDelCarrito(id_base, talle, event) {
  if (event?.stopPropagation) event.stopPropagation();

  console.log("[CARRITO] ‚ùå Eliminando:", { id_base, talle });

  carrito = carrito.filter(p => {
    if (talle && talle !== "unico") {
      return !(p.id_base === id_base && p.talle === talle);
    } else {
      return p.id_base !== id_base;
    }
  });

  actualizarCarrito();
}
    
function mostrarSubgrupo(subgrupo, event) {
  console.log("üü© mostrarSubgrupo llamada con:", subgrupo);

  // Buscar el grupo actualmente activo (bot√≥n marcado)
  const grupoActivoBtn = document.querySelector('.btn-grupo.active');
  const grupoActivo = grupoActivoBtn ? grupoActivoBtn.textContent.trim() : null;
  console.log("üéØ Grupo activo detectado:", grupoActivo);

  if (!grupoActivo) {
    console.warn("‚ö†Ô∏è No hay grupo activo para mostrar subgrupo:", subgrupo);
    return;
  }

  // Resetear botones de subgrupo
  document.querySelectorAll('.btn-subgrupo').forEach(btn => btn.classList.remove('active'));
  if (event?.target) {
    event.target.classList.add('active');
    console.log("üëâ Bot√≥n subgrupo marcado:", event.target.textContent);
  }

  // Actualizar estado can√≥nico
  const grupoCanon = String(grupoActivo).trim();
  const subCanon = String(subgrupo || "").trim();

  window.currentGrupo = grupoCanon.toLowerCase();
  window.currentSub = subCanon.toLowerCase();
  console.log("üìå Estado can√≥nico actualizado:", { currentGrupo: window.currentGrupo, currentSub: window.currentSub });

  // Filtrar y renderizar productos del grupo + subgrupo
  console.log("‚û°Ô∏è Llamando a filtrarSubcategoria con:", { grupoCanon, subCanon });
  filtrarSubcategoria(grupoCanon, subCanon);

  // Logs extra para verificar DOM y estilos
  const cont = document.getElementById("productos");
  if (cont) {
    console.log("üì• Hijos actuales en #productos despu√©s de mostrarSubgrupo:", cont.children.length);
  }
}

function actualizarPrecioEnCarrito(nombre, nuevoPrecio) {
  let cambio = false;
  carrito.forEach(item => {
    if (item.nombre === nombre && item.precio !== nuevoPrecio) {
      item.precio = nuevoPrecio;
      cambio = true;
    }
  });
  if (cambio) actualizarCarrito();
}

function sincronizarPreciosDelCarrito() {
  carrito.forEach(item => {
    const idPrecio = "precio_" + (item.id_base || item.nombre.replace(/ /g, "_"));
    const precioSpan = document.getElementById(idPrecio);
    if (precioSpan) {
      const precioActual = parseFloat(precioSpan.textContent);
      if (!isNaN(precioActual)) {
        item.precio = precioActual;
      }
    }
  });
}

function actualizarCarrito() {
  sincronizarPreciosDelCarrito();

  const lista = document.getElementById('listaCarrito');
  const totalSpan = document.getElementById('totalCarrito');
  if (!lista || !totalSpan) return;

  lista.innerHTML = '';
  let suma = 0;

  if (carrito.length === 0) {
    lista.innerHTML = "<li>üõí Carrito vac√≠o</li>";
    totalSpan.textContent = "0.00";
    return;
  }

  const fmt = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  carrito.forEach(item => {
    const subtotal = item.precio * item.cantidad;
    suma += subtotal;

    // Crear descripci√≥n con talle y color
    let descripcion = item.nombre;
    if (item.talle) descripcion += ` (Talle: ${item.talle})`;
    if (item.color) descripcion += ` (Color: ${item.color})`;

    lista.insertAdjacentHTML("beforeend", `
      <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <div>
          <div><strong>${descripcion}</strong></div>
          <div style="font-size: 0.9em; color: #666;">
            ${item.cantidad} x $${item.precio.toFixed(2)} = $${subtotal.toFixed(2)}
          </div>
        </div>
        <button onmousedown="eliminarDelCarrito('${item.id_base}', '${item.talle}', '${item.color}', event)" 
                style="background: none; border: none; color: red; font-weight: bold; font-size: 16px; cursor: pointer;">
          ‚ùå
        </button>
      </li>`);
  });

  totalSpan.textContent = fmt.format(suma);
}

function mostrarTodos() {
  const panelGrupos = document.getElementById('panelGrupos');
  const panelSub = document.getElementById('panelSubcategorias');

  if (!panelGrupos || !panelSub) return;

  // Forzar reflow para animaciones CSS
  void panelGrupos.offsetWidth;
  void panelSub.offsetWidth;
  
  console.log("üîÑ Mostrar/Ocultar paneles - Estado actual:");
  console.log("   Panel Grupos oculto?:", panelGrupos.classList.contains('oculta'));
  console.log("   Panel Sub oculto?:", panelSub.classList.contains('oculta'));
  
  // Toggle panel grupos con animaci√≥n
  if (panelGrupos.classList.contains('oculta')) {
    panelGrupos.classList.remove('oculta');
    console.log("üëâ Mostrando panel grupos con animaci√≥n");
  } else {
    panelGrupos.classList.add('oculta');
    console.log("üëâ Ocultando panel grupos con animaci√≥n");
  }
  
  // Siempre ocultar panel subcategor√≠as si est√° visible
  if (!panelSub.classList.contains('oculta')) {
    panelSub.classList.add('oculta');
    console.log("üëâ Ocultando panel subcategor√≠as");
  }
  
  // Ajustar posiciones despu√©s de un peque√±o delay para que CSS anime
  setTimeout(() => {
    ajustarPosicionesPaneles();
  }, 50);
}
    
function irAContacto() {
  const contacto = document.getElementById('ubicacion');
  if (contacto) contacto.scrollIntoView({ behavior: 'smooth' });
}
window.irAContacto = irAContacto; // si us√°s m√≥dulos

    
function renderProducto(p) {
  console.log("üéØ [RENDER-PRODUCTO] INICIO =====================================");
  console.log("üì¶ Datos completos del producto recibido:", JSON.stringify(p, null, 2));
  
  const card = document.createElement("div");
  card.className = "col-lg-4 col-md-6 col-sm-12 mb-4 fade-reorder card-producto";
  card.dataset.id = p.id_base;
  card.dataset.precio = p.precio;

  // üî• VERIFICACI√ìN DETALLADA DEL PRECIO ANTERIOR
  console.log("üí∞ [PRECIO-ANTERIOR] Verificaci√≥n:");
  console.log("   - ID Producto:", p.id_base);
  console.log("   - Nombre:", p.nombre);
  console.log("   - Precio actual (p.precio):", p.precio, "(tipo:", typeof p.precio, ")");
  console.log("   - Precio anterior (p.precio_anterior):", p.precio_anterior, "(tipo:", typeof p.precio_anterior, ")");
  console.log("   - ¬øExiste campo precio_anterior?:", "precio_anterior" in p);
  console.log("   - Valor directo:", p.precio_anterior);
  console.log("   - Valor parseado:", parseFloat(p.precio_anterior));
  
  // üî• NUEVA L√ìGICA: Usar precio_anterior de Firestore (viene del backend)
  const precioActual = parseFloat(p.precio) || 0;
  const precioAnterior = parseFloat(p.precio_anterior) || 0;
  
  console.log("   - Precio actual (parseado):", precioActual);
  console.log("   - Precio anterior (parseado):", precioAnterior);
  
  // Detectar si es oferta (precio anterior > precio actual)
  const esOferta = precioAnterior > 0 && precioAnterior > precioActual;
  const descuentoPorcentaje = esOferta ? 
    Math.round(((precioAnterior - precioActual) / precioAnterior) * 100) : 0;
  
  console.log("   - ¬øEs oferta?:", esOferta, "(precioAnterior > precioActual:", precioAnterior > precioActual, ")");
  console.log("   - Porcentaje descuento:", descuentoPorcentaje + "%");
  console.log("   - Ahorro: $" + (precioAnterior - precioActual).toFixed(2));
  
  // üî• BUSCAR EN EL ARRAY GLOBAL POR SI ACASO
  if (!esOferta && window.todosLosProductos) {
    console.log("   üîç Buscando precio anterior en array global...");
    const productoCompleto = window.todosLosProductos.find(prod => prod.id_base === p.id_base);
    if (productoCompleto) {
      console.log("   - Producto encontrado en array global:", productoCompleto.nombre);
      console.log("   - precio_anterior en array:", productoCompleto.precio_anterior);
      if (productoCompleto.precio_anterior && productoCompleto.precio_anterior > precioActual) {
        console.log("   ‚ö†Ô∏è ¬°OFERTA ENCONTRADA EN ARRAY GLOBAL!");
        console.log("   - Usando precio anterior del array:", productoCompleto.precio_anterior);
        // Sobreescribir si encontramos oferta en el array global
        precioAnterior = parseFloat(productoCompleto.precio_anterior) || 0;
        esOferta = precioAnterior > 0 && precioAnterior > precioActual;
      }
    }
  }
  
  console.log("   - Resultado final - Es oferta:", esOferta);
  console.log("   - Precio anterior final:", precioAnterior);
  
  // üî• SOLO usar stock_por_talle
  const tieneStockPorTalle = p.stock_por_talle && Object.keys(p.stock_por_talle).length > 0;
  
  console.log("üì¶ [STOCK] Verificaci√≥n:");
  console.log("   - Tiene stock_por_talle:", tieneStockPorTalle);
  console.log("   - stock_por_talle:", p.stock_por_talle);
  console.log("   - stock:", p.stock);
  
  let stockData = {};
  let opcionesTalles = "";
  let talleInicial = "";
  let stockInicial = 0;
  
  if (tieneStockPorTalle) {
    // üî• PRIORIDAD √öNICA: Usar stock_por_talle
    stockData = p.stock_por_talle;
    window[`stock_por_talle_${p.id_base}`] = stockData;
    
    console.log("   - Stock por talle asignado:", stockData);
    
    // Generar opciones de talles
    const tallesDisponibles = Object.keys(stockData);
    console.log("   - Talles disponibles:", tallesDisponibles);
    
    tallesDisponibles.forEach(talle => {
      const stock = stockData[talle] || 0;
      console.log(`   - Talle ${talle}: stock = ${stock}`);
      
      const opcion = stock > 0 ? 
        `<option value="${talle}">${talle} (${stock} disponible${stock > 1 ? 's' : ''})</option>` :
        `<option value="${talle}" disabled>${talle} (Agotado)</option>`;
      opcionesTalles += opcion;
      
      // Si es el primer talle con stock, usarlo como valor inicial
      if (stockInicial === 0 && stock > 0) {
        stockInicial = stock;
        talleInicial = talle;
        console.log(`   - Talle inicial elegido: ${talleInicial} (stock: ${stockInicial})`);
      }
    });
    
    // Si ning√∫n talle tiene stock, usar el primero disponible
    if (stockInicial === 0 && tallesDisponibles.length > 0) {
      talleInicial = tallesDisponibles[0];
      stockInicial = stockData[talleInicial] || 0;
      console.log(`   - Sin stock, usando primer talle: ${talleInicial} (stock: ${stockInicial})`);
    }
  } else {
    // üî• Producto sin talles
    const stockGeneral = p.stock || 0;
    stockData = { "unico": stockGeneral };
    window[`stock_por_talle_${p.id_base}`] = stockData;
    stockInicial = stockGeneral;
    console.log(`   - Producto sin talles, stock general: ${stockGeneral}`);
  }
  
  const mostrarStock = stockInicial > 0 ? stockInicial : "Sin stock";
  const claseStock = stockInicial > 0 ? "" : "text-danger";
  
  console.log("   - Stock inicial final:", stockInicial);
  console.log("   - Talle inicial final:", talleInicial);

  // Escape de caracteres
  const nombreEscapado = p.nombre.replace(/'/g, "\\'").replace(/"/g, '\\"');
  const descripcionEscapada = (p.descripcion || "").replace(/'/g, "\\'").replace(/"/g, '\\"');
  const imagenUrl = p.imagen_url || '/static/img/fallback.webp';
  const grupoEscapado = (p.grupo || "").replace(/'/g, "\\'");
  const subgrupoEscapado = (p.subgrupo || "").replace(/'/g, "\\'");
  
  // Escapar URLs de fotos adicionales
  const fotosAdicionalesSeguras = (p.fotos_adicionales || []).map(foto => 
    foto.replace(/'/g, "\\'").replace(/"/g, '\\"')
  );
  
  console.log("üîó [URLs] Verificaci√≥n:");
  console.log("   - Imagen URL:", imagenUrl);
  console.log("   - Fotos adicionales:", fotosAdicionalesSeguras.length);
  
  const onclickAgregar = `agregarAlCarritoDOM('${nombreEscapado}', 'precio_${p.id_base}', 'cantidad_${p.id_base}', '${p.id_base}', '${grupoEscapado}', '${subgrupoEscapado}')`;
  
  // üî• CREAR URL DE WHATSAPP ESPEC√çFICA PARA ESTE PRODUCTO
  let whatsappUrl = configWhatsApp;
  
  if (configWhatsApp && configWhatsApp.includes("wa.me")) {
    const mensaje = encodeURIComponent(`Hola! Me interesa el producto: "${p.nombre}" - Precio: $${p.precio}\n\n¬øPodr√≠as darme m√°s informaci√≥n?`);
    const match = configWhatsApp.match(/wa\.me\/(\d+)/);
    if (match) {
      const numero = match[1];
      whatsappUrl = `https://wa.me/${numero}?text=${mensaje}`;
    } else {
      whatsappUrl = `${configWhatsApp}?text=${mensaje}`;
    }
  }
  
  // üî• FOTOS ADICIONALES - SIN TEXTO
  const fotosAdicionalesHTML = fotosAdicionalesSeguras.length > 0 ? `
    <div class="fotos-adicionales mt-2">
      <div class="d-flex flex-wrap mt-1" style="gap: 3px;">
        ${fotosAdicionalesSeguras.slice(0, 3).map((foto, idx) => `
          <img src="${foto}" 
               alt="Foto ${idx+1}" 
               style="width: 40px; height: 40px; object-fit: cover; border-radius: 3px; cursor: pointer;"
               onclick="openModal('${foto}')">
        `).join('')}
        ${fotosAdicionalesSeguras.length > 3 ? `<span class="ms-1 text-muted">+${fotosAdicionalesSeguras.length - 3}</span>` : ''}
      </div>
    </div>
  ` : '';
  
  console.log("üé® [HTML] Generando HTML para producto:", p.nombre);
  console.log("   - Es oferta en HTML:", esOferta);
  console.log("   - Badge oferta generado:", esOferta ? "S√ç" : "NO");
  console.log("   - Precio anterior en HTML:", precioAnterior);
  console.log("   - Precio actual en HTML:", precioActual);
  
  card.innerHTML = `
  <div class="card-giratoria">
    <div class="card-contenedor">
      <!-- FRENTE (COMPLETO) -->
      <div class="card-front">
        <!-- üî• ETIQUETA OFERTA SIMPLE - SOLO ADELANTE -->
        ${esOferta ? `
          <div class="oferta-badge" style="
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(45deg, #ff4757, #ff3838);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            z-index: 5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            animation: pulseOferta 2s infinite;
          ">
            üî• OFERTA -${descuentoPorcentaje}%
          </div>
        ` : ''}
        
        <!-- Bot√≥n para girar -->
        <button class="btn-girar" onclick="girarCard(this)">
          üîÑ
        </button>
        
        <img src="${imagenUrl}${imagenUrl.includes('?') ? '&' : '?'}format=webp" 
             alt="${p.nombre}" 
             loading="lazy"
             width="300" 
             height="180"
             style="width:100%; height:180px; object-fit:contain; border-radius:4px; cursor:pointer; opacity:1;"
             onclick="openModal('${imagenUrl}')">
        <div class="card-body">
          <h5 class="card-title">${p.nombre}</h5>
          
          <p class="mb-2">
            <strong>Precio:</strong> 
            <!-- üî• PRECIO ANTERIOR TACHADO (SOLO SI HAY OFERTA) -->
            ${esOferta ? `
              <span style="text-decoration: line-through; color: #999; font-size: 0.9rem; margin-right: 5px;">
                $${precioAnterior.toFixed(2)}
              </span>
            ` : ''}
            <!-- üî• PRECIO ACTUAL EN ROJO SI ES OFERTA -->
            $<span id="precio_${p.id_base}" style="${esOferta ? 'color: #ff4757; font-weight: bold;' : ''}">${p.precio}</span>
            ${esOferta ? `<small style="color: #20c997; font-weight: bold; margin-left: 5px;">Ahorras $${(precioAnterior - precioActual).toFixed(2)}</small>` : ''}
          </p>
          
          ${Object.keys(stockData).length > 0 && Object.keys(stockData)[0] !== "unico" ? `
  <div class="mb-2 d-flex align-items-center gap-2">
    <label class="mb-0"><strong>Talle:</strong></label>
    <select id="talle_${p.id_base}" class="form-select form-select-sm w-auto"
            onchange="actualizarStockPorTalle('${p.id_base}', this.value)"
            style="min-width: 80px; max-width: 160px;">
      <option value="">-</option>
      ${opcionesTalles}
    </select>
  </div>
` : ""}
          
          <div class="mt-3 d-flex align-items-center gap-2">
            <input type="number" min="1" max="${stockInicial > 0 ? stockInicial : 1}" value="1"
                   id="cantidad_${p.id_base}"
                   class="form-control form-control-sm" style="width: 70px;"
                   ${stockInicial <= 0 ? "disabled" : ""}>
            
            <button type="button" class="btn btn-secondary btn-sm" id="btn_agregar_${p.id_base}"
              onclick="${onclickAgregar}"
              ${stockInicial <= 0 ? "disabled style='opacity:0.5'" : ""}>
              ${stockInicial > 0 ? "Agregar al carrito" : "‚ùå Sin stock"}
            </button>
          </div>
          
          <!-- üî• FOTOS ADICIONALES (SIN TEXTO) -->
          ${fotosAdicionalesHTML}
          
          <!-- üî• BOT√ìN WHATSAPP ESPEC√çFICO -->
          ${whatsappUrl ? `
            <div class="mt-3">
              <a href="${whatsappUrl}" class="btn btn-whatsapp btn-sm w-100 d-flex align-items-center justify-content-center gap-2" target="_blank" style="background-color: #0c6909; color: white;">
                <img src="/static/img/whatsapp.png" alt="WhatsApp" style="width: 20px; height: 20px;">
                Consultar
              </a>
            </div>
          ` : ""}
        </div>
      </div>
      
      <!-- REVERSO (SOLO DESCRIPCI√ìN) -->
      <div class="card-back" style="display: flex; flex-direction: column; height: 100%;">
        <!-- Bot√≥n para volver al frente (arriba a la derecha) -->
        <button class="btn-reversa" onclick="girarCard(this)" style="position: absolute; top: 10px; right: 10px;">
          ‚Ü©Ô∏è
        </button>
        
        <!-- üî• √ÅREA DE DESCRIPCI√ìN (OCUPA TODO EL ESPACIO DISPONIBLE) -->
        <div class="descripcion-area" style="
          flex: 1;
          padding: 80px 80px 80px 80px;
          overflow-y: auto;
          text-align: center;
          flex-direction: column;
          justify-content: center;
          /* üî• OCULTAR BARRA DE SCROLL PERO PERMITIR SCROLL */
          scrollbar-width: none; /* Firefox */
          -ms-overflow-style: none; /* IE/Edge */
        ">
          <div class="descripcion-area::-webkit-scrollbar {
            display: none; /* Chrome/Safari/Opera */
          }">
            ${p.descripcion ? `
              <div style="
                font-size: 1rem;
                line-height: 1.5;
                color: #f8f9fa;
                white-space: pre-line;
                max-height: 100%;
              ">
                ${p.descripcion}
              </div>
            ` : `
              <div style="
                font-size: 1rem;
                color: #adb5bd;
                font-style: italic;
              ">
                Este producto no tiene descripci√≥n adicional.
              </div>
            `}
          </div>
        </div>
        
        <!-- üî• SECCI√ìN INFERIOR (FUERA DEL √ÅREA DE DESCRIPCI√ìN) -->
        <div class="card-back-footer" style="
          padding: 15px;
          border-top: 1px solid rgba(255,255,255,0.1);
          background: rgba(0,0,0,0.2);
        ">
          ${Object.keys(stockData).length > 0 && Object.keys(stockData)[0] !== "unico" ? `
            <div class="mb-2" style="
              background: rgba(255,255,255,0.05);
              padding: 8px 12px;
              border-radius: 6px;
              font-size: 0.9rem;
              color: #dee2e6;
            ">
              <strong>Talles:</strong> ${Object.keys(stockData).join(", ")}
            </div>
          ` : ""}
          
          <!-- üî• REMOVIDO: Secci√≥n de oferta en el reverso -->
          
          <div class="mt-2">
            <button class="btn btn-secondary btn-sm w-100" onclick="girarCard(this)">
              üîÑ Volver al frente
            </button>
          </div>
          
          ${window.modoAdmin ? `
            <div class="mt-2 d-flex gap-2">
              <button type="button" class="btn btn-warning btn-sm w-50"
                onclick="cargarProductoCompletoParaEditar('${p.id_base}')">
                ‚úèÔ∏è Editar
              </button>
              <button type="button" class="btn btn-danger btn-sm w-50"
                onclick="eliminarProducto('${p.id_base}')">
                üóëÔ∏è Eliminar
              </button>
            </div>
          ` : ""}
        </div>
      </div>
    </div>
  </div>
`;

  console.log("‚úÖ [RENDER-PRODUCTO] HTML generado para:", p.nombre);
  console.log("   - Badge visible en DOM:", esOferta ? "S√ç (deber√≠a verse)" : "NO");
  console.log("   - Card a√±adida al DOM");
  console.log("üéØ [RENDER-PRODUCTO] FIN ======================================\n\n");

  // üî• Configurar talle inicial
  if (talleInicial) {
    setTimeout(() => {
      const talleSelect = document.getElementById(`talle_${p.id_base}`);
      if (talleSelect) {
        talleSelect.value = talleInicial;
        actualizarStockPorTalle(p.id_base, talleInicial);
      }
    }, 100);
  }

  requestAnimationFrame(() => card.classList.add("show"));
  setTimeout(() => card.classList.remove("fade-reorder"), 50);

  return card;
}

// üî• AGREGAR ANIMACI√ìN CSS PARA LA ETIQUETA DE OFERTA
(function() {
  // Verificar si ya existe la animaci√≥n
  if (!document.getElementById('oferta-animacion-css')) {
    const style = document.createElement('style');
    style.id = 'oferta-animacion-css';
    style.textContent = `
      @keyframes pulseOferta {
        0%, 100% { 
          transform: scale(1); 
          box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
        }
        50% { 
          transform: scale(1.05); 
          box-shadow: 0 4px 10px rgba(255, 71, 87, 0.5); 
        }
      }
      
      /* Estilo para productos en oferta */
      .card-producto.oferta {
        border-left: 4px solid #ff4757;
      }
      
      /* Destacar precio en oferta */
      .precio-oferta {
        color: #ff4757 !important;
        font-weight: bold !important;
        font-size: 1.1rem !important;
      }
      
      .precio-anterior-tachado {
        text-decoration: line-through;
        color: #999;
        font-size: 0.9rem;
        margin-right: 5px;
      }
      
      /* Para ofertas especiales (descuento > 20%) */
      .oferta-especial {
        background: linear-gradient(45deg, #ff9500, #ff5e3a) !important;
      }
    `;
    document.head.appendChild(style);
    console.log("‚úÖ Animaci√≥n CSS de ofertas agregada");
  }
})();

function actualizarUIStock(idProducto, stockDisponible, talleSeleccionado) {
  const stockSpan = document.getElementById(`stock_${idProducto}`);
  const cantidadInput = document.getElementById(`cantidad_${idProducto}`);
  const agregarBtn = document.getElementById(`btn_agregar_${idProducto}`);
  
  // Actualizar el texto del stock
  stockSpan.textContent = stockDisponible > 0 ? stockDisponible : "Sin stock";
  
  // Actualizar clases de estilo
  if (stockDisponible > 0) {
    stockSpan.classList.remove("text-danger");
    stockSpan.classList.add("text-success");
    setTimeout(() => stockSpan.classList.remove("text-success"), 1000);
  } else {
    stockSpan.classList.remove("text-success");
    stockSpan.classList.add("text-danger");
  }
  
  // Actualizar el input de cantidad
  cantidadInput.max = stockDisponible;
  
  if (stockDisponible > 0) {
    cantidadInput.disabled = false;
    const valorActual = parseInt(cantidadInput.value) || 1;
    cantidadInput.value = Math.min(valorActual, stockDisponible);
    
    agregarBtn.disabled = false;
    agregarBtn.style.opacity = "1";
    agregarBtn.textContent = "Agregar al carrito";
  } else {
    cantidadInput.disabled = true;
    cantidadInput.value = "0";
    
    agregarBtn.disabled = true;
    agregarBtn.style.opacity = "0.5";
    agregarBtn.textContent = "Sin stock";
  }
  
  console.log(`‚úÖ Stock actualizado: Talle ${talleSeleccionado} ‚Üí ${stockDisponible} unidades`);
}

    
// üî• FUNCI√ìN COMPLETA PARA ACTUALIZAR OFERTAS EN LOTE (para administradores)
async function actualizarOfertasAutomaticamente() {
  if (!window.modoAdmin) {
    console.log("‚ùå Solo administradores pueden usar esta funci√≥n");
    return;
  }
  
  console.log("üîÑ Iniciando actualizaci√≥n autom√°tica de ofertas...");
  
  const productos = window.todosLosProductos || [];
  let ofertasActualizadas = 0;
  let productosProcesados = 0;
  let errores = 0;
  
  if (productos.length === 0) {
    console.log("‚ùå No hay productos para analizar");
    return;
  }
  
  console.log(`üìä Analizando ${productos.length} productos...`);
  
  // üî• 1. Calcular promedios por grupo para referencia
  const promediosPorGrupo = {};
  const productosPorGrupo = {};
  
  // Agrupar productos por grupo
  productos.forEach(p => {
    const grupo = p.grupo || "General";
    const precio = parseFloat(p.precio) || 0;
    
    if (!promediosPorGrupo[grupo]) {
      promediosPorGrupo[grupo] = { suma: 0, cantidad: 0 };
      productosPorGrupo[grupo] = [];
    }
    
    promediosPorGrupo[grupo].suma += precio;
    promediosPorGrupo[grupo].cantidad++;
    productosPorGrupo[grupo].push(p);
  });
  
  // Calcular promedios
  Object.keys(promediosPorGrupo).forEach(grupo => {
    promediosPorGrupo[grupo].promedio = 
      promediosPorGrupo[grupo].suma / promediosPorGrupo[grupo].cantidad;
    console.log(`üìà Grupo "${grupo}": Promedio $${promediosPorGrupo[grupo].promedio.toFixed(2)} (${promediosPorGrupo[grupo].cantidad} productos)`);
  });
  
  // üî• 2. Analizar cada producto
  for (const producto of productos) {
    try {
      productosProcesados++;
      
      const precioActual = parseFloat(producto.precio) || 0;
      const precioAnteriorActual = parseFloat(producto.precio_anterior) || 0;
      const grupo = producto.grupo || "General";
      const promedioGrupo = promediosPorGrupo[grupo]?.promedio || precioActual;
      
      // Si ya tiene oferta v√°lida, mantenerla
      if (precioAnteriorActual > precioActual) {
        console.log(`‚úÖ Producto "${producto.nombre}" ya tiene oferta activa (${precioAnteriorActual} ‚Üí ${precioActual})`);
        continue;
      }
      
      let necesitaActualizar = false;
      let nuevoPrecioAnterior = 0;
      
      // üî• L√ìGICA 1: Si el precio est√° por debajo del promedio del grupo (20% o m√°s)
      if (precioActual < promedioGrupo * 0.8) {
        // El precio es al menos 20% menor que el promedio del grupo
        nuevoPrecioAnterior = Math.round(promedioGrupo); // Usar promedio como referencia
        necesitaActualizar = true;
        console.log(`üî• ${producto.nombre}: Est√° 20%+ bajo el promedio del grupo ($${precioActual} < $${promedioGrupo.toFixed(2)})`);
      }
      
      // üî• L√ìGICA 2: Comparar con productos similares en el mismo grupo
      const productosSimilares = productosPorGrupo[grupo] || [];
      if (productosSimilares.length > 1) {
        const preciosSimilares = productosSimilares
          .map(p => parseFloat(p.precio) || 0)
          .filter(p => p > 0);
        
        if (preciosSimilares.length > 0) {
          const precioMaximo = Math.max(...preciosSimilares);
          const precioMinimo = Math.min(...preciosSimilares);
          
          // Si el precio est√° cerca del m√≠nimo pero no es el √∫nico
          if (precioActual <= precioMinimo * 1.1 && precioActual < precioMaximo * 0.9) {
            nuevoPrecioAnterior = precioMaximo; // Usar el precio m√°s alto como referencia
            necesitaActualizar = true;
            console.log(`üî• ${producto.nombre}: Es de los m√°s baratos en su grupo (${precioActual} vs m√°ximo ${precioMaximo})`);
          }
        }
      }
      
      // üî• L√ìGICA 3: Detectar precios que termin en .99 o .90 (t√≠pico de ofertas)
      const decimal = precioActual - Math.floor(precioActual);
      if ((decimal >= 0.95 && decimal <= 0.99) || decimal === 0.90) {
        // Posible precio de oferta, buscar referencia
        const referencia = Math.round(precioActual / 0.8); // Asume 20% de descuento
        if (referencia > precioActual) {
          nuevoPrecioAnterior = referencia;
          necesitaActualizar = true;
          console.log(`üî• ${producto.nombre}: Tiene patr√≥n de precio de oferta (termina en .${Math.round(decimal*100)})`);
        }
      }
      
      // üî• L√ìGICA 4: Productos sin stock no deber√≠an estar en oferta
      const tieneStock = producto.stock > 0 || 
                        (producto.stock_por_talle && Object.values(producto.stock_por_talle).some(v => v > 0));
      
      if (!tieneStock && precioAnteriorActual > 0) {
        // Producto agotado pero marcado como oferta, quitar oferta
        nuevoPrecioAnterior = 0;
        necesitaActualizar = true;
        console.log(`üì¶ ${producto.nombre}: Sin stock, quitando oferta`);
      }
      
      // üî• 3. Aplicar cambios si es necesario
      if (necesitaActualizar && nuevoPrecioAnterior !== precioAnteriorActual) {
        try {
          
          ofertasActualizadas++;
        } catch (error) {
          console.error(`‚ùå Error actualizando ${producto.nombre}:`, error);
          errores++;
        }
      }
      
    } catch (error) {
      console.error(`‚ùå Error procesando producto ${producto.nombre}:`, error);
      errores++;
    }
  }
  
  // üî• 4. Resumen
  console.log(`
üéØ RESUMEN ACTUALIZACI√ìN DE OFERTAS:
   üì¶ Productos analizados: ${productosProcesados}
   üî• Ofertas actualizadas: ${ofertasActualizadas}
   ‚ùå Errores: ${errores}
   ‚è±Ô∏è  Tiempo: ${new Date().toLocaleTimeString()}
  `);
  
  // üî• 5. Si hubo cambios, actualizar la vista
  if (ofertasActualizadas > 0) {
    alert(`‚úÖ Se actualizaron ${ofertasActualizadas} ofertas autom√°ticamente`);
    
    // Recargar productos
    setTimeout(() => {
      if (typeof cargarProductos === "function") {
        cargarProductos();
      }
    }, 2000);
  } else {
    console.log("‚ÑπÔ∏è No se detectaron cambios necesarios en las ofertas");
  }
  
  return {
    total: productosProcesados,
    actualizados: ofertasActualizadas,
    errores: errores
  };
}



    
// üëâ Funci√≥n que arma el array de items reales desde el carrito
function obtenerCarrito() {
  console.log("üõí [obtenerCarrito] Mapeando carrito a formato MP:");
  
  return carrito.map(item => {
    // Debug: mostrar qu√© datos tenemos
    console.log("  - Item original:", item);
    
    // Asegurar que precio sea n√∫mero
    let precio = item.precio;
    if (typeof precio === 'string') {
      // Remover s√≠mbolo $ y comas, convertir a float
      precio = parseFloat(precio.replace(/[$,]/g, '').trim());
      console.log(`  - Precio convertido de "${item.precio}" a ${precio}`);
    } else if (typeof precio === 'number') {
      console.log(`  - Precio ya es n√∫mero: ${precio}`);
    } else {
      precio = 0;
      console.warn(`  - ‚ö†Ô∏è Precio no v√°lido: ${precio}, usando 0`);
    }
    
    // Asegurar que cantidad sea n√∫mero
    let cantidad = parseInt(item.cantidad) || 1;
    
    const itemFormateado = {
      title: item.nombre + (item.talle ? ` (${item.talle})` : ""),
      quantity: cantidad,
      unit_price: precio,
      id_base: item.id_base,
      grupo: item.grupo || "",
      subgrupo: item.subgrupo || "",
      // üëá MANTENER tambi√©n los campos originales para Firestore
      nombre: item.nombre,
      precio: precio,  // precio convertido a n√∫mero
      cantidad: cantidad,
      talle: item.talle || ""
    };
    
    console.log("  - Item formateado para MP:", itemFormateado);
    return itemFormateado;
  });
}
    
function ajustarPosicionesPaneles() {
  const panelGrupos = document.getElementById('panelGrupos');
  const panelSub = document.getElementById('panelSubcategorias');
  const barraNav = document.querySelector('.barra-navegacion');

  if (!panelGrupos || !panelSub) {
    console.warn("‚ö†Ô∏è No existen paneles en el DOM");
    return;
  }

  console.log("üîß ajustando posiciones de paneles...");

  // Solo ajustar si no est√°n ocultos
  if (!panelGrupos.classList.contains('oculta')) {
    const alturaBarra = barraNav ? barraNav.offsetHeight : 0;
    panelGrupos.style.top = alturaBarra + 'px';
    panelGrupos.style.position = 'fixed';
    panelGrupos.style.left = '0';
    panelGrupos.style.right = '0';
    console.log("üìê Panel grupos ‚Üí top:", panelGrupos.style.top, "alturaBarra:", alturaBarra);
  }

  if (!panelSub.classList.contains('oculta')) {
    const alturaBarra = barraNav ? barraNav.offsetHeight : 0;
    const alturaGrupos = panelGrupos.offsetHeight || 0;
    const topCalc = alturaBarra + alturaGrupos;
    panelSub.style.top = topCalc + 'px';
    panelSub.style.position = 'fixed';
    panelSub.style.left = '0';
    panelSub.style.right = '0';
    console.log("üìê Panel subcategorias ‚Üí top:", panelSub.style.top, 
                "alturaBarra:", alturaBarra, "alturaGrupos:", alturaGrupos);
  }

  // Logs de diagn√≥stico
  const styleGrupos = window.getComputedStyle(panelGrupos);
  const styleSub = window.getComputedStyle(panelSub);
  console.log("üëÅÔ∏è PanelGrupos - display:", styleGrupos.display, "opacity:", styleGrupos.opacity, "top:", styleGrupos.top);
  console.log("üëÅÔ∏è PanelSub - display:", styleSub.display, "opacity:", styleSub.opacity, "top:", styleSub.top);
}


    
////////////////////////////////////////////////////
document.addEventListener("DOMContentLoaded", () => {
  // Ajustar posiciones al cargar y al redimensionar
  window.addEventListener("load", ajustarPosicionesPaneles);
  window.addEventListener("resize", ajustarPosicionesPaneles);

  // Bot√≥n Productos
  const btnProductos = document.getElementById("btnProductos");
  if (btnProductos) {
    btnProductos.addEventListener("click", (e) => {
      e.stopPropagation();
      const panelGrupos = document.getElementById("panelGrupos");
      if (panelGrupos) {
        // Forzar reflow para animaci√≥n
        void panelGrupos.offsetWidth;
        if (panelGrupos.classList.contains('oculta')) {
          panelGrupos.classList.remove("oculta");
          console.log("üëâ Mostrando panel grupos desde bot√≥n Productos");
        } else {
          panelGrupos.classList.add("oculta");
          console.log("üëâ Ocultando panel grupos desde bot√≥n Productos");
        }
      }
      setTimeout(ajustarPosicionesPaneles, 100);
    });
  }

  // Detectar token admin
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("token");

  if (token) {
    window.modoAdmin = true;
    window.tokenAdmin = token;
    document.getElementById("logoutAdminWrapper").style.display = "block";
  } else {
    window.modoAdmin = false;
  }

  // Inicializar variables de stock por talle
  window.stockPorTalleData = {};
  
  // Delegaci√≥n de eventos para actualizaci√≥n de stock por talle
  document.addEventListener('change', (e) => {
    if (e.target.id && e.target.id.startsWith('talle_')) {
      const idProducto = e.target.id.replace('talle_', '');
      const talleSeleccionado = e.target.value;
      if (talleSeleccionado) {
        actualizarStockPorTalle(idProducto, talleSeleccionado);
      }
    }
  });

  // Bot√≥n Subcategor√≠as (si existe)
  const btnSubcategorias = document.getElementById("btnSubcategorias");
  if (btnSubcategorias) {
    btnSubcategorias.addEventListener("click", () => {
      const panelSub = document.getElementById("panelSubcategorias");
      if (panelSub) {
        // Forzar reflow para animaci√≥n
        void panelSub.offsetWidth;
        if (panelSub.classList.contains('oculta')) {
          panelSub.classList.remove("oculta");
          console.log("üëâ Mostrando panel subcategor√≠as");
        } else {
          panelSub.classList.add("oculta");
          console.log("üëâ Ocultando panel subcategor√≠as");
        }
      }
      setTimeout(ajustarPosicionesPaneles, 100);
    });
  }

  // Delegaci√≥n de eventos para botones de grupo din√°micos
  document.addEventListener("click", (e) => {
    // Animaci√≥n para botones de grupo
    if (e.target.classList.contains("btn-grupo")) {
      setTimeout(() => {
        ajustarPosicionesPaneles();
      }, 150);
    }

    // Animaci√≥n para botones de subgrupo
    if (e.target.classList.contains("btn-subgrupo")) {
      setTimeout(() => {
        ajustarPosicionesPaneles();
      }, 150);
    }

    // Cerrar carrito al hacer clic fuera
    const carritoDiv = document.getElementById("carrito");
    const toggleBtn = document.getElementById("toggleCarrito");
    if (carritoDiv && toggleBtn) {
      const visible = carritoDiv.style.display === "block";
      const clicFueraCarrito = !carritoDiv.contains(e.target) && !toggleBtn.contains(e.target);
      if (visible && clicFueraCarrito) {
        carritoDiv.style.display = "none";
      }
    }

    // Cerrar paneles al hacer clic fuera (con animaci√≥n)
    const panelGrupos = document.getElementById("panelGrupos");
    const panelSub = document.getElementById("panelSubcategorias");
    if (panelGrupos && panelSub) {
      const esClickDentroGrupos = panelGrupos.contains(e.target);
      const esClickDentroSub = panelSub.contains(e.target);
      const esBotonGrupo = e.target.classList.contains("btn-grupo");
      const esBotonSubgrupo = e.target.classList.contains("btn-subgrupo");
      const esBotonNavegacion = !!e.target.closest(".barra-navegacion");

      // Solo cerrar si no se hizo clic en elementos relacionados
      if (!esClickDentroGrupos && !esClickDentroSub && !esBotonGrupo && 
          !esBotonSubgrupo && !esBotonNavegacion && e.target.id !== 'btnProductos') {
        
        // Animar el cierre de los paneles
        if (!panelGrupos.classList.contains('oculta')) {
          void panelGrupos.offsetWidth;
          panelGrupos.classList.add("oculta");
          console.log("üëâ Cerrando panel grupos (clic fuera)");
        }
        
        if (!panelSub.classList.contains('oculta')) {
          void panelSub.offsetWidth;
          panelSub.classList.add("oculta");
          console.log("üëâ Cerrando panel subcategor√≠as (clic fuera)");
        }
        
        // Ajustar posiciones despu√©s de la animaci√≥n
        setTimeout(ajustarPosicionesPaneles, 200);
      }
    }
  });

  // üëâ Ordenar por precio
  const ordenSelect = document.getElementById("ordenPrecio");
  if (ordenSelect) {
    ordenSelect.addEventListener("change", (e) => {
      const valor = e.target.value; // "asc" o "desc"

      const grupoActivoBtn = document.querySelector(".btn-grupo.active");
      const grupoActivo = grupoActivoBtn ? grupoActivoBtn.textContent.trim() : null;

      const subActivoBtn = document.querySelector(".btn-subgrupo.active");
      const subActivo = subActivoBtn ? subActivoBtn.textContent.trim() : null;

      let productosFiltrados = window.todosLosProductos;

      if (grupoActivo) {
        productosFiltrados = productosFiltrados.filter(
          p => p.grupo?.toLowerCase() === grupoActivo.toLowerCase()
        );
      }
      if (subActivo) {
        productosFiltrados = productosFiltrados.filter(
          p => p.subgrupo?.toLowerCase() === subActivo.toLowerCase()
        );
      }

      productosFiltrados.sort((a, b) => {
        const pa = parseFloat(a.precio) || 0;
        const pb = parseFloat(b.precio) || 0;
        return valor === "asc" ? pa - pb : pb - pa;
      });

      const cont = document.getElementById("productos");
      if (!cont) return;

      // Animar la transici√≥n
      cont.style.opacity = '0.5';
      cont.style.transition = 'opacity 0.3s ease';
      
      setTimeout(() => {
        cont.innerHTML = "";
        productosFiltrados.forEach((p) => {
          const card = renderProducto(p);
          cont.appendChild(card);
          setTimeout(() => card.classList.remove("fade-reorder"), 50);
        });
        
        // Restaurar opacidad
        setTimeout(() => {
          cont.style.opacity = '1';
        }, 50);
      }, 300);
    });
  }

  // üëâ Mostrar card de admin y bot√≥n Mercado Pago si corresponde
  if (window.modoAdmin) {
    const adminCard = document.getElementById("adminCard");
    if (adminCard) {
      adminCard.style.opacity = '0';
      adminCard.classList.remove("d-none");
      setTimeout(() => {
        adminCard.style.transition = 'opacity 0.5s ease';
        adminCard.style.opacity = '1';
      }, 100);
    }

    const btnConfigMP = document.getElementById("configurarMP");
    if (btnConfigMP) {
      btnConfigMP.style.opacity = '0';
      btnConfigMP.classList.remove("d-none");
      setTimeout(() => {
        btnConfigMP.style.transition = 'opacity 0.5s ease';
        btnConfigMP.style.opacity = '1';
      }, 200);
    }
  }

  // üëâ Inicializar Mercado Pago din√°micamente
  async function initMercadoPago() {
    try {
      const resp = await fetch(`${URL_BACKEND}/api/mp_public_key?email=${encodeURIComponent(email)}`);
      const data = await resp.json();

      if (data.public_key) {
        window.mp = new MercadoPago(data.public_key, { locale: 'es-AR' });
        const pagarBtn = document.getElementById('btn_pagar');
        if (pagarBtn) {
          pagarBtn.disabled = false;
          pagarBtn.style.opacity = '0';
          setTimeout(() => {
            pagarBtn.style.transition = 'opacity 0.5s ease';
            pagarBtn.style.opacity = '1';
          }, 300);
        }
      } else {
        const pagarBtn = document.getElementById('btn_pagar');
        if (pagarBtn) pagarBtn.disabled = true;
      }
    } catch (err) {
      const pagarBtn = document.getElementById('btn_pagar');
      if (pagarBtn) pagarBtn.disabled = true;
    }
  }

  initMercadoPago();

  // üëâ Funci√≥n de pago limpia con integraci√≥n de orden_id
  async function pagarConMercadoPago() {
    try {
      if (!carrito.length) {
        return;
      }

      const response = await fetch("https://mpagina.onrender.com/pagar", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          carrito,
          email_vendedor: email,
          url_retorno: window.location.href
        })
      });

      let data = null;
      const contentType = response.headers.get("content-type") || "";

      if (response.ok && contentType.includes("application/json")) {
        try {
          data = await response.json();
        } catch {
          return;
        }
      } else {
        return;
      }

      if (data && data.preference_id && window.mp) {
        // üëá Guardar el external_reference para usarlo en el formulario cliente
        window.orden_id = data.external_reference;

        window.mp.checkout({
          preference: { id: data.preference_id },
          autoOpen: true
        });
      } else if (data && data.init_point) {
        // üëá Guardar tambi√©n aqu√≠
        window.orden_id = data.external_reference;
        window.location.href = data.init_point;
      }
    } catch {
      return;
    }
  }

  const pagarBtn = document.getElementById('btn_pagar');
  if (pagarBtn) {
    pagarBtn.addEventListener("click", pagarConMercadoPago);
  }

  // üëâ VERIFICAR SI VENIMOS DE CONFIGURACI√ìN EXITOSA DE MERCADO PAGO
  // Esto debe ejecutarse despu√©s de todo lo anterior
  setTimeout(() => {
    const urlParams = new URLSearchParams(window.location.search);
    
    if (urlParams.get('mp_configurado') === 'true') {
        const emailVendedor = urlParams.get('email');
        console.log('‚úÖ Mercado Pago configurado exitosamente para:', emailVendedor);
        
        // Mostrar mensaje de √©xito con animaci√≥n
        const alertDiv = document.createElement('div');
        alertDiv.textContent = '‚úÖ ¬°Mercado Pago configurado exitosamente! Ahora puedes recibir pagos.';
        alertDiv.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%) translateY(-20px);
          background: linear-gradient(45deg, #4CAF50, #8BC34A);
          color: white;
          padding: 15px 30px;
          border-radius: 10px;
          z-index: 9999;
          opacity: 0;
          transition: all 0.5s ease;
          box-shadow: 0 5px 15px rgba(0,0,0,0.3);
          font-family: 'Raleway', sans-serif;
          font-weight: bold;
        `;
        document.body.appendChild(alertDiv);
        
        // Animar entrada
        setTimeout(() => {
          alertDiv.style.opacity = '1';
          alertDiv.style.transform = 'translateX(-50%) translateY(0)';
        }, 100);
        
        // Animar salida despu√©s de 3 segundos
        setTimeout(() => {
          alertDiv.style.opacity = '0';
          alertDiv.style.transform = 'translateX(-50%) translateY(-20px)';
          setTimeout(() => alertDiv.remove(), 500);
        }, 3000);
        
        // Limpiar la URL (quitar par√°metros)
        const nuevaURL = window.location.pathname + '?email=' + encodeURIComponent(emailVendedor);
        window.history.replaceState({}, document.title, nuevaURL);
        
        // Recargar para actualizar el estado (mostrar bot√≥n de pago, etc.)
        setTimeout(() => {
            location.reload();
        }, 1500);
    }
    
    if (urlParams.get('mp_error') === '1') {
        const errorDiv = document.createElement('div');
        errorDiv.textContent = '‚ùå Hubo un error al configurar Mercado Pago. Por favor, intenta nuevamente.';
        errorDiv.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%) translateY(-20px);
          background: linear-gradient(45deg, #f44336, #FF5252);
          color: white;
          padding: 15px 30px;
          border-radius: 10px;
          z-index: 9999;
          opacity: 0;
          transition: all 0.5s ease;
          box-shadow: 0 5px 15px rgba(0,0,0,0.3);
          font-family: 'Raleway', sans-serif;
          font-weight: bold;
        `;
        document.body.appendChild(errorDiv);
        
        // Animar entrada
        setTimeout(() => {
          errorDiv.style.opacity = '1';
          errorDiv.style.transform = 'translateX(-50%) translateY(0)';
        }, 100);
        
        // Animar salida despu√©s de 3 segundos
        setTimeout(() => {
          errorDiv.style.opacity = '0';
          errorDiv.style.transform = 'translateX(-50%) translateY(-20px)';
          setTimeout(() => errorDiv.remove(), 500);
        }, 3000);
        
        // Limpiar la URL
        const nuevaURL = window.location.pathname;
        window.history.replaceState({}, document.title, nuevaURL);
    }
  }, 100);
  
  // Ajustar posiciones iniciales despu√©s de un breve delay
  setTimeout(() => {
    ajustarPosicionesPaneles();
  }, 500);
});
    
// üëâ Nueva funci√≥n ordenarGrupo
function ordenarGrupo(valor) {
  console.log("üîÑ ordenarGrupo llamada con:", valor);

  const cont = document.getElementById("productos");
  if (!cont) return;

  const grupoCanon = window.currentGrupo;
  const subCanon = window.currentSub;

  let productosFiltrados = window.todosLosProductos.filter(p =>
    String(p.grupo || "").toLowerCase() === grupoCanon.toLowerCase() &&
    String(p.subgrupo || "").toLowerCase() === subCanon.toLowerCase()
  );

  productosFiltrados.sort((a, b) => {
    const pa = Number(a.precio) || 0;
    const pb = Number(b.precio) || 0;
    return valor === "asc" ? pa - pb : pb - pa;
  });
  console.log("üìä Productos ordenados:", valor, productosFiltrados);

  cont.innerHTML = "";

  const grupoDiv = document.createElement("div");
  grupoDiv.className = "grupo-section";
  grupoDiv.innerHTML = `<h3>${grupoCanon}</h3>`;

  const subDiv = document.createElement("div");
  subDiv.className = "subgrupo-bloque";
  subDiv.innerHTML = `<h4>${subCanon}</h4>`;

  productosFiltrados.forEach(p => {
    const card = renderProducto(p);
    subDiv.appendChild(card);

    requestAnimationFrame(() => card.classList.add("show"));
    setTimeout(() => card.classList.remove("fade-reorder"), 50);

    console.log("üõí Card insertada en subgrupo:", p.nombre);
  });

  grupoDiv.appendChild(subDiv);
  cont.appendChild(grupoDiv);
  console.log("‚úÖ Bloque renderizado en ordenarGrupo, hijos finales:", cont.children.length);
}

window.ordenarGrupo = ordenarGrupo;

// Bot√≥n Productos (SOLO cierra los paneles)
const btnProductos = document.getElementById('btnProductos');
if (btnProductos) {
  btnProductos.addEventListener('click', (e) => {
    e.stopPropagation(); // Evita conflictos con otros clicks

    // Solo ocultamos los paneles
    document.getElementById('panelGrupos').classList.add('oculta');
    document.getElementById('panelSubcategorias').classList.add('oculta');
    
    // Eliminamos mostrarTodos() y scrollTo() para no alterar la vista
  });
}

// Animaci√≥n del logo al hacer click
document.querySelector('.logo').addEventListener('click', function() {
  const logo = this;
  
  // 1. Desactivar click temporalmente
  logo.style.pointerEvents = 'none';
  
  // 2. Rotaci√≥n 3D (360¬∞ en Y)
  logo.style.transition = 'transform 0.8s ease, opacity 0.4s ease';
  logo.style.transform = 'rotateY(360deg)';
  logo.style.opacity = '0.7';
  
  // 3. Crear mensaje flotante - POSICI√ìN FIJA en lugar de absoluta
  const mensaje = document.createElement('div');
  mensaje.textContent = 'Gracias por la visita! ‚ù§Ô∏è';
  mensaje.style.position = 'fixed'; // Cambiado de absolute a fixed
  mensaje.style.top = '50%';
  mensaje.style.left = '50%';
  mensaje.style.transform = 'translate(-50%, -50%) scale(0.8)';
  mensaje.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
  mensaje.style.color = 'white';
  mensaje.style.padding = '15px 25px';
  mensaje.style.borderRadius = '20px';
  mensaje.style.fontFamily = "'Raleway', sans-serif";
  mensaje.style.fontSize = '1.2rem';
  mensaje.style.fontWeight = 'bold';
  mensaje.style.zIndex = '999999'; // Valor MUY alto
  mensaje.style.opacity = '0';
  mensaje.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
  mensaje.style.boxShadow = '0 0 30px rgba(255, 255, 255, 0.7), 0 0 60px rgba(139, 92, 246, 0.5)';
  mensaje.style.backdropFilter = 'blur(10px)';
  mensaje.style.webkitBackdropFilter = 'blur(10px)';
  mensaje.style.border = '2px solid rgba(255, 255, 255, 0.3)';
  
  // Asegurar que no est√© dentro del contenedor con overflow:hidden
  document.body.appendChild(mensaje);
  
  // 4. Animaci√≥n secuencial
  setTimeout(() => {
    // Mostrar mensaje
    mensaje.style.opacity = '1';
    mensaje.style.transform = 'translate(-50%, -50%) scale(1.1)';
    
    setTimeout(() => {
      // Escalar mensaje y volver a normal
      mensaje.style.transform = 'translate(-50%, -50%) scale(1)';
      
      setTimeout(() => {
        // Ocultar mensaje
        mensaje.style.opacity = '0';
        mensaje.style.transform = 'translate(-50%, -50%) scale(0.8)';
        
        setTimeout(() => {
          mensaje.remove();
        }, 500);
        
        // 5. Restaurar logo
        logo.style.transform = 'rotateY(0deg)';
        logo.style.opacity = '1';
        
        setTimeout(() => {
          logo.style.pointerEvents = 'auto';
          logo.style.transition = '';
        }, 800);
        
      }, 1500); // Tiempo que se muestra el mensaje
      
    }, 300); // Tiempo escala del mensaje
    
  }, 400); // Tiempo inicio mensaje despu√©s de rotaci√≥n
});
    
</script>
<script type="module">
const usarFirestore = false;
const email = "ferj.9622@gmail.com";

setTimeout(() => {
  if (!window.todosLosProductos || window.todosLosProductos.length === 0) return;

  const primerGrupo = [...new Set(window.todosLosProductos.map(p => p.grupo))][0];
  if (!primerGrupo) return;

  const primerGrupoId = primerGrupo.trim().toLowerCase().replace(/\s+/g, '_');
  const primerGrupoDiv = document.getElementById('grupo_' + primerGrupoId);
  if (primerGrupoDiv) primerGrupoDiv.classList.add('active');

  const subgrupos = [...new Set(window.todosLosProductos
    .filter(p => p.grupo === primerGrupo)
    .map(p => p.subgrupo))];

  // Normalizar: si no hay subgrupo, usar General_{grupo}
  let primerSubgrupoNombre = subgrupos[0]?.trim();
  if (!primerSubgrupoNombre) {
    primerSubgrupoNombre = `General_${primerGrupo}`;
  }

  if (primerGrupoId && primerSubgrupoNombre) {
    filtrarSubcategoria(primerGrupo, primerSubgrupoNombre);
  }
}, 100);

document.getElementById("btnQuitarFoto").addEventListener("click", () => {
  // Limpiar input y preview
  document.getElementById("inputFoto").value = "";
  const imgPreview = document.getElementById("previewFoto");
  imgPreview.src = "";
  imgPreview.classList.add("d-none");

  // Ocultar bot√≥n y limpiar referencia global
  document.getElementById("btnQuitarFoto").classList.add("d-none");
  window.fotoOptimizada = null;

  console.log("üóëÔ∏è Foto eliminada");
});
   
</script>
<script>
// FRONTEND - Enviar TODO en una sola llamada
async function procesarPago() {
    // 1. Obtener datos del formulario
    const nombre = document.querySelector('input[name="nombre"]').value;
    const apellido = document.querySelector('input[name="apellido"]').value;
    const email = document.querySelector('input[name="email"]').value;
    const telefono = document.querySelector('input[name="telefono"]').value;
    
    // 2. Preparar payload
    const payload = {
        email_vendedor: window.email_vendedor, // Aseg√∫rate de tener esto
        numero_vendedor: window.numero_vendedor,
        items: window.carritoActual,
        cliente_nombre: `${nombre} ${apellido}`.trim(),
        cliente_email: email,
        cliente_telefono: telefono,
        orden_id: window.orden_id // Si tienes preorden, si no lo quitas
    };
    
    console.log("[PAGAR] Enviando:", payload);
    
    try {
        const response = await fetch('/pagar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert("Error: " + data.error);
        } else if (data.init_point) {
            // Guardar el external_reference en localStorage para referencia
            localStorage.setItem('ultima_orden', data.external_reference);
            // Redirigir a Mercado Pago
            window.location.href = data.init_point;
        }
        
    } catch (error) {
        console.error("Error:", error);
        alert("Error al procesar el pago");
    }
}
</script>  
<script src="https://sdk.mercadopago.com/js/v2"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>  
<script>
  const PUBLIC_KEY = "";
  let mp = null;

  if (PUBLIC_KEY) {
    mp = new MercadoPago(PUBLIC_KEY, { locale: 'es-AR' });
  }

  const pagarBtn = document.getElementById('btn_pagar');
  if (pagarBtn && !PUBLIC_KEY) {
    pagarBtn.disabled = true;
  }

  console.log("PUBLIC_KEY:", PUBLIC_KEY);
</script>
</body>
</html>
